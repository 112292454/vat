{% extends "base.html" %}

{% block title %}B站设置 - VAT{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <h1 class="text-2xl font-bold mb-6">B站设置</h1>
    
    <!-- 登录状态 -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-lg font-semibold mb-4">账号状态</h2>
        
        <div id="login-status">
            {% if login_status.logged_in %}
            <div class="flex items-center gap-4">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                    ✓ 已登录
                </span>
                <span class="text-gray-700">
                    {{ login_status.username }} (UID: {{ login_status.uid }}) Lv{{ login_status.level }}
                </span>
            </div>
            {% else %}
            <div class="flex items-center gap-4">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
                    ✗ 未登录
                </span>
                <button onclick="showLoginModal()" class="px-4 py-2 bg-pink-500 text-white rounded hover:bg-pink-600">
                    扫码登录
                </button>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 合集管理 -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold">合集管理</h2>
            <button onclick="showCreateSeasonModal()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm"
                    {% if not login_status.logged_in %}disabled{% endif %}>
                + 创建合集
            </button>
        </div>
        
        {% if not login_status.logged_in %}
        <p class="text-gray-500">请先登录B站账号</p>
        {% elif seasons %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">名称</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">视频数</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for s in seasons %}
                    <tr>
                        <td class="px-4 py-3 text-sm text-gray-900">{{ s.season_id }}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">{{ s.name or '(未命名)' }}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">{{ s.total }}</td>
                        <td class="px-4 py-3 text-sm space-x-2">
                            <button onclick="toggleSeasonEpisodes({{ s.season_id }})" class="text-blue-600 hover:text-blue-800">
                                查看
                            </button>
                            <button onclick="sortSeason({{ s.season_id }})" class="text-green-600 hover:text-green-800">
                                排序
                            </button>
                            <button onclick="copySeasonId({{ s.season_id }})" class="text-gray-500 hover:text-gray-700">
                                复制ID
                            </button>
                        </td>
                    </tr>
                    <tr id="season-episodes-{{ s.season_id }}" class="hidden">
                        <td colspan="4" class="px-4 py-3 bg-gray-50">
                            <div class="text-sm text-gray-500">点击"查看"加载...</div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-gray-500">暂无合集</p>
        {% endif %}
    </div>
    
    <!-- 合集同步 -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold">合集同步</h2>
            <button onclick="loadSyncPlaylists()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm"
                    {% if not login_status.logged_in %}disabled{% endif %}
                    id="btn-load-sync">
                刷新列表
            </button>
        </div>
        
        {% if not login_status.logged_in %}
        <p class="text-gray-500">请先登录B站账号</p>
        {% else %}
        <p class="text-sm text-gray-500 mb-3">
            将本地 Playlist 中已上传到B站但未入集的视频，批量添加到对应合集并排序。
        </p>
        <div id="sync-container">
            <p class="text-gray-400 text-sm">点击"刷新列表"加载可同步的 Playlist</p>
        </div>
        {% endif %}
    </div>
    
    <!-- 审核退回管理 -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold">审核退回管理</h2>
            <button onclick="loadRejectedVideos()" class="px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 text-sm"
                    {% if not login_status.logged_in %}disabled{% endif %}
                    id="btn-load-rejected">
                刷新退回列表
            </button>
        </div>
        
        {% if not login_status.logged_in %}
        <p class="text-gray-500">请先登录B站账号</p>
        {% else %}
        <div id="rejected-container">
            <p class="text-gray-500">点击"刷新退回列表"加载被退回的稿件</p>
        </div>
        {% endif %}
    </div>
    
    <!-- 上传模板设置 -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-lg font-semibold mb-4">上传模板</h2>
        <p class="text-sm text-gray-500 mb-4">
            模板支持变量替换，格式: <code class="bg-gray-100 px-1 rounded">${变量名}</code>
        </p>
        
        <form id="template-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">标题模板</label>
                <input type="text" name="title_template" 
                       value="{{ templates.title }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="【${channel_name}】${translated_title}">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">简介模板</label>
                <textarea name="desc_template" rows="6"
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                          placeholder="${translated_desc}">{{ templates.description }}</textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">可用变量 <span class="text-gray-400 font-normal">(点击插入)</span></label>
                <div class="space-y-2 text-xs">
                    <div>
                        <span class="text-gray-500 mr-2">频道:</span>
                        <span class="px-2 py-1 bg-blue-50 rounded cursor-pointer hover:bg-blue-100" onclick="insertVar('channel_name')">channel_name</span>
                        <span class="px-2 py-1 bg-blue-50 rounded cursor-pointer hover:bg-blue-100" onclick="insertVar('channel_url')">channel_url</span>
                        <span class="px-2 py-1 bg-blue-50 rounded cursor-pointer hover:bg-blue-100" onclick="insertVar('channel_id')">channel_id</span>
                    </div>
                    <div>
                        <span class="text-gray-500 mr-2">翻译:</span>
                        <span class="px-2 py-1 bg-green-50 rounded cursor-pointer hover:bg-green-100" onclick="insertVar('translated_title')">translated_title</span>
                        <span class="px-2 py-1 bg-green-50 rounded cursor-pointer hover:bg-green-100" onclick="insertVar('translated_desc')">translated_desc</span>
                        <span class="px-2 py-1 bg-green-50 rounded cursor-pointer hover:bg-green-100" onclick="insertVar('tldr')">tldr</span>
                    </div>
                    <div>
                        <span class="text-gray-500 mr-2">原始:</span>
                        <span class="px-2 py-1 bg-yellow-50 rounded cursor-pointer hover:bg-yellow-100" onclick="insertVar('original_title')">original_title</span>
                        <span class="px-2 py-1 bg-yellow-50 rounded cursor-pointer hover:bg-yellow-100" onclick="insertVar('original_desc')">original_desc</span>
                        <span class="px-2 py-1 bg-yellow-50 rounded cursor-pointer hover:bg-yellow-100" onclick="insertVar('original_date')">original_date</span>
                    </div>
                    <div>
                        <span class="text-gray-500 mr-2">视频:</span>
                        <span class="px-2 py-1 bg-purple-50 rounded cursor-pointer hover:bg-purple-100" onclick="insertVar('source_url')">source_url</span>
                        <span class="px-2 py-1 bg-purple-50 rounded cursor-pointer hover:bg-purple-100" onclick="insertVar('video_id')">video_id</span>
                        <span class="px-2 py-1 bg-purple-50 rounded cursor-pointer hover:bg-purple-100" onclick="insertVar('duration')">duration</span>
                        <span class="px-2 py-1 bg-purple-50 rounded cursor-pointer hover:bg-purple-100" onclick="insertVar('duration_minutes')">duration_minutes</span>
                    </div>
                    <div>
                        <span class="text-gray-500 mr-2">列表:</span>
                        <span class="px-2 py-1 bg-pink-50 rounded cursor-pointer hover:bg-pink-100" onclick="insertVar('playlist_name')">playlist_name</span>
                        <span class="px-2 py-1 bg-pink-50 rounded cursor-pointer hover:bg-pink-100" onclick="insertVar('playlist_index')">playlist_index</span>
                    </div>
                    <div>
                        <span class="text-gray-500 mr-2">其他:</span>
                        <span class="px-2 py-1 bg-gray-100 rounded cursor-pointer hover:bg-gray-200" onclick="insertVar('today')">today</span>
                        <span class="px-2 py-1 bg-gray-100 rounded cursor-pointer hover:bg-gray-200" onclick="insertVar('brand')">brand</span>
                        <span class="px-2 py-1 bg-gray-100 rounded cursor-pointer hover:bg-gray-200" onclick="insertVar('project_description')">project_description</span>
                    </div>
                </div>
            </div>
            
            <div class="pt-4">
                <button type="button" onclick="saveTemplates()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                    保存模板
                </button>
                <!-- <span class="text-sm text-gray-500 ml-4">注意：修改后需要编辑 config/default.yaml 以持久保存</span> -->
            </div>
        </form>
    </div>
    
    <!-- 默认设置 -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold mb-4">默认上传设置</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">版权类型</label>
                <select name="copyright" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="1" {% if config.copyright == 1 %}selected{% endif %}>自制</option>
                    <option value="2" {% if config.copyright == 2 %}selected{% endif %}>转载</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">默认分区</label>
                <input type="number" name="default_tid" value="{{ config.default_tid }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">默认标签</label>
                <input type="text" name="default_tags" value="{{ config.default_tags | join(', ') }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md"
                       placeholder="VTuber, 日本">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">默认合集</label>
                <select name="season_id" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="">不加入合集</option>
                    {% for s in seasons %}
                    <option value="{{ s.season_id }}" {% if config.season_id == s.season_id %}selected{% endif %}>
                        {{ s.name or '(未命名)' }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="flex items-center">
                <input type="checkbox" name="auto_cover" id="auto_cover" 
                       {% if config.auto_cover %}checked{% endif %}
                       class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                <label for="auto_cover" class="ml-2 text-sm text-gray-700">自动使用视频封面</label>
            </div>
        </div>
        
        <div class="pt-4 mt-4 border-t">
            <button type="button" onclick="saveSettings()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                保存设置
            </button>
            <!-- <span class="text-sm text-gray-500 ml-4">注意：修改后需要编辑 config/default.yaml 以持久保存</span> -->
        </div>
    </div>
</div>

<!-- 登录弹窗 -->
<div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">扫码登录B站</h3>
            <button onclick="closeLoginModal()" class="text-gray-500 hover:text-gray-700">&times;</button>
        </div>
        
        <div id="qrcode-container" class="text-center py-4">
            <div class="text-gray-500">正在获取二维码...</div>
        </div>
        
        <div id="login-message" class="text-center text-sm text-gray-500 mt-2"></div>
    </div>
</div>

<!-- 创建合集弹窗 -->
<div id="create-season-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">创建合集</h3>
            <button onclick="closeCreateSeasonModal()" class="text-gray-500 hover:text-gray-700">&times;</button>
        </div>
        
        <form id="create-season-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">合集名称</label>
                <input type="text" name="season_title" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">合集简介</label>
                <textarea name="season_desc" rows="3"
                          class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" onclick="closeCreateSeasonModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                    取消
                </button>
                <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    创建
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// 登录相关
let qrData = null;
let loginCheckInterval = null;

function showLoginModal() {
    document.getElementById('login-modal').classList.remove('hidden');
    fetchQRCode();
}

function closeLoginModal() {
    document.getElementById('login-modal').classList.add('hidden');
    if (loginCheckInterval) {
        clearInterval(loginCheckInterval);
        loginCheckInterval = null;
    }
}

async function fetchQRCode() {
    const container = document.getElementById('qrcode-container');
    container.innerHTML = '<div class="text-gray-500">正在获取二维码...</div>';
    
    try {
        const resp = await fetch('/bilibili/qrcode');
        const data = await resp.json();
        
        if (data.success) {
            qrData = data.qr_data;
            // 生成二维码图片
            container.innerHTML = `
                <div class="flex flex-col items-center">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(data.qr_url)}" 
                         alt="登录二维码" class="border rounded">
                    <p class="mt-2 text-sm text-gray-600">请使用B站APP扫描</p>
                </div>
            `;
            document.getElementById('login-message').textContent = '等待扫码...';
            
            // 启动后台登录任务（会阻塞等待扫码完成）
            startLoginTask();
            
            // 同时开始轮询登录状态
            startLoginCheck();
        } else {
            container.innerHTML = `<div class="text-red-500">${data.error}</div>`;
        }
    } catch (e) {
        container.innerHTML = `<div class="text-red-500">获取二维码失败: ${e}</div>`;
    }
}

async function startLoginTask() {
    // 调用后台登录接口，它会在后台线程等待扫码
    try {
        const formData = new FormData();
        formData.append('qr_data', qrData);
        await fetch('/bilibili/login', {
            method: 'POST',
            body: formData
        });
    } catch (e) {
        console.error('启动登录任务失败:', e);
    }
}

function startLoginCheck() {
    // 每3秒检查一次登录状态
    loginCheckInterval = setInterval(async () => {
        try {
            const resp = await fetch('/bilibili/status');
            const data = await resp.json();
            
            if (data.logged_in) {
                clearInterval(loginCheckInterval);
                document.getElementById('login-message').textContent = '登录成功！';
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        } catch (e) {
            console.error('检查登录状态失败:', e);
        }
    }, 3000);
}

// 创建合集
function showCreateSeasonModal() {
    document.getElementById('create-season-modal').classList.remove('hidden');
}

function closeCreateSeasonModal() {
    document.getElementById('create-season-modal').classList.add('hidden');
}

document.getElementById('create-season-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData();
    formData.append('title', form.season_title.value);
    formData.append('description', form.season_desc.value);
    
    try {
        const resp = await fetch('/bilibili/seasons', {
            method: 'POST',
            body: formData
        });
        const data = await resp.json();
        
        if (data.success) {
            alert(`合集创建成功！ID: ${data.season_id}`);
            location.reload();
        } else {
            alert(`创建失败: ${data.error}`);
        }
    } catch (e) {
        alert(`创建失败: ${e}`);
    }
});

// 复制合集ID
function copySeasonId(id) {
    navigator.clipboard.writeText(id.toString());
    alert('已复制: ' + id);
}

// 查看合集视频列表（展开/折叠）
async function toggleSeasonEpisodes(seasonId) {
    const row = document.getElementById(`season-episodes-${seasonId}`);
    if (!row) return;
    
    if (!row.classList.contains('hidden')) {
        row.classList.add('hidden');
        return;
    }
    
    // 加载
    const cell = row.querySelector('td');
    cell.innerHTML = '<div class="text-sm text-gray-500">加载中...</div>';
    row.classList.remove('hidden');
    
    try {
        const resp = await fetch(`/bilibili/season/${seasonId}/episodes`);
        const data = await resp.json();
        
        if (!data.success) {
            cell.innerHTML = `<div class="text-sm text-red-500">${escapeHtml(data.error)}</div>`;
            return;
        }
        
        if (data.episodes.length === 0) {
            cell.innerHTML = '<div class="text-sm text-gray-400">合集中暂无视频</div>';
            return;
        }
        
        let html = `<div class="text-xs text-gray-400 mb-2">共 ${data.total} 个视频</div>`;
        html += '<div class="max-h-64 overflow-y-auto space-y-1">';
        data.episodes.forEach((ep, idx) => {
            html += `<div class="flex items-center gap-2 text-sm py-1 px-2 hover:bg-gray-100 rounded">
                <span class="text-gray-400 w-6 text-right">${idx + 1}.</span>
                <span class="text-gray-700 truncate flex-1">${escapeHtml(ep.title)}</span>
                <a href="https://www.bilibili.com/video/av${ep.aid}" target="_blank" 
                   class="text-xs text-blue-400 hover:text-blue-600 flex-shrink-0">av${ep.aid}</a>
            </div>`;
        });
        html += '</div>';
        cell.innerHTML = html;
    } catch (e) {
        cell.innerHTML = `<div class="text-sm text-red-500">加载失败: ${e}</div>`;
    }
}

// 触发合集排序
async function sortSeason(seasonId) {
    if (!confirm(`确认对合集 ${seasonId} 执行自动排序？\n（按标题中的 #数字 升序排列）`)) return;
    
    try {
        const resp = await fetch(`/bilibili/season/${seasonId}/sort`, { method: 'POST' });
        const data = await resp.json();
        if (data.success) {
            alert('排序完成');
        } else {
            alert('排序失败: ' + data.error);
        }
    } catch (e) {
        alert('排序异常: ' + e);
    }
}

// =============================================================================
// 合集同步
// =============================================================================

let syncPlaylists = [];

async function loadSyncPlaylists() {
    const container = document.getElementById('sync-container');
    const btn = document.getElementById('btn-load-sync');
    if (!container || !btn) return;
    
    btn.disabled = true;
    btn.textContent = '加载中...';
    container.innerHTML = '<p class="text-gray-400 text-sm">正在获取...</p>';
    
    try {
        const resp = await fetch('/bilibili/sync-playlists');
        const data = await resp.json();
        
        if (!data.success) {
            container.innerHTML = `<p class="text-red-500 text-sm">${escapeHtml(data.error)}</p>`;
            return;
        }
        
        syncPlaylists = data.playlists;
        renderSyncPlaylists();
    } catch (e) {
        container.innerHTML = `<p class="text-red-500 text-sm">加载失败: ${e}</p>`;
    } finally {
        btn.disabled = false;
        btn.textContent = '刷新列表';
    }
}

function renderSyncPlaylists() {
    const container = document.getElementById('sync-container');
    if (!container) return;
    
    if (syncPlaylists.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-sm">没有配置了目标合集的 Playlist</p>';
        return;
    }
    
    let html = '<div class="space-y-3">';
    
    for (const pl of syncPlaylists) {
        const hasPending = pl.pending_count > 0;
        const statusColor = pl.sync_status === 'running' ? 'blue'
            : pl.sync_status === 'completed' ? 'green'
            : pl.sync_status === 'partial' ? 'yellow'
            : pl.sync_status === 'failed' ? 'red'
            : 'gray';
        
        html += `
            <div class="border rounded-lg p-4" id="sync-card-${pl.playlist_id}">
                <div class="flex justify-between items-start">
                    <div class="flex-1 min-w-0">
                        <h3 class="text-sm font-medium text-gray-900 truncate">${escapeHtml(pl.title)}</h3>
                        <div class="text-xs text-gray-500 mt-1 space-x-3">
                            <span>合集: ${pl.season_id}</span>
                            <span>已上传: ${pl.total_uploaded}</span>
                            <span>已同步: ${pl.synced_count}</span>
                            <span class="${hasPending ? 'text-orange-600 font-medium' : 'text-gray-400'}">
                                待同步: ${pl.pending_count}
                            </span>
                        </div>
                    </div>
                    <div class="ml-4 flex-shrink-0" id="sync-action-${pl.playlist_id}">`;
        
        if (pl.sync_status === 'running') {
            html += `
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs bg-blue-100 text-blue-700">
                            <svg class="animate-spin -ml-1 mr-1.5 h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                            同步中...
                        </span>`;
        } else if (hasPending) {
            html += `
                        <button onclick="startSeasonSync('${pl.playlist_id}')" 
                                class="px-3 py-1.5 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
                            同步 ${pl.pending_count} 个
                        </button>`;
        } else {
            html += `<span class="text-xs text-green-600">已全部同步</span>`;
        }
        
        html += `
                    </div>
                </div>`;
        
        // 显示上次同步结果
        if (pl.sync_status && pl.sync_status !== 'running' && pl.sync_message) {
            html += `<div class="text-xs mt-2 text-${statusColor}-600">${escapeHtml(pl.sync_message)}</div>`;
        }
        
        html += '</div>';
    }
    
    html += '</div>';
    container.innerHTML = html;
    
    // 对正在运行的任务启动轮询
    for (const pl of syncPlaylists) {
        if (pl.sync_status === 'running') {
            pollSyncStatus(pl.playlist_id);
        }
    }
}

async function startSeasonSync(playlistId) {
    const actionDiv = document.getElementById(`sync-action-${playlistId}`);
    if (!actionDiv) return;
    
    actionDiv.innerHTML = `
        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs bg-blue-100 text-blue-700">
            <svg class="animate-spin -ml-1 mr-1.5 h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
            启动中...
        </span>`;
    
    try {
        const resp = await fetch(`/bilibili/season-sync/${encodeURIComponent(playlistId)}`, { method: 'POST' });
        const data = await resp.json();
        
        if (data.success) {
            actionDiv.innerHTML = `
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs bg-blue-100 text-blue-700">
                    <svg class="animate-spin -ml-1 mr-1.5 h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                    同步中...
                </span>`;
            if (data.patched > 0) {
                const card = document.getElementById(`sync-card-${playlistId}`);
                if (card) {
                    const note = document.createElement('div');
                    note.className = 'text-xs mt-2 text-gray-500';
                    note.textContent = `已为 ${data.patched} 个视频补充合集标记`;
                    card.appendChild(note);
                }
            }
            pollSyncStatus(playlistId);
        } else {
            actionDiv.innerHTML = `<span class="text-xs text-red-500">${escapeHtml(data.error)}</span>`;
        }
    } catch (e) {
        actionDiv.innerHTML = `<span class="text-xs text-red-500">启动失败: ${e}</span>`;
    }
}

async function pollSyncStatus(playlistId) {
    try {
        const resp = await fetch(`/bilibili/season-sync/${encodeURIComponent(playlistId)}/status`);
        const data = await resp.json();
        
        const actionDiv = document.getElementById(`sync-action-${playlistId}`);
        if (!actionDiv) return;
        
        if (data.status === 'running') {
            // 继续轮询
            setTimeout(() => pollSyncStatus(playlistId), 3000);
        } else if (data.status === 'completed') {
            actionDiv.innerHTML = `<span class="text-xs text-green-600">同步完成</span>`;
            // 显示结果
            const card = document.getElementById(`sync-card-${playlistId}`);
            if (card && data.result) {
                let existing = card.querySelector('.sync-result');
                if (!existing) {
                    existing = document.createElement('div');
                    existing.className = 'sync-result text-xs mt-2 text-green-600';
                    card.appendChild(existing);
                }
                existing.textContent = `${data.result.success} 个视频已添加到合集`;
            }
            // 延迟刷新列表
            setTimeout(loadSyncPlaylists, 2000);
        } else if (data.status === 'partial') {
            actionDiv.innerHTML = `
                <button onclick="startSeasonSync('${playlistId}')" 
                        class="px-3 py-1.5 bg-orange-500 text-white rounded text-xs hover:bg-orange-600">
                    重试
                </button>`;
            const card = document.getElementById(`sync-card-${playlistId}`);
            if (card) {
                let existing = card.querySelector('.sync-result');
                if (!existing) {
                    existing = document.createElement('div');
                    existing.className = 'sync-result text-xs mt-2 text-yellow-600';
                    card.appendChild(existing);
                }
                existing.textContent = data.message || '部分视频同步失败';
            }
        } else if (data.status === 'failed') {
            actionDiv.innerHTML = `
                <button onclick="startSeasonSync('${playlistId}')" 
                        class="px-3 py-1.5 bg-red-500 text-white rounded text-xs hover:bg-red-600">
                    重试
                </button>`;
            const card = document.getElementById(`sync-card-${playlistId}`);
            if (card) {
                let existing = card.querySelector('.sync-result');
                if (!existing) {
                    existing = document.createElement('div');
                    existing.className = 'sync-result text-xs mt-2 text-red-600';
                    card.appendChild(existing);
                }
                existing.textContent = data.message || '同步失败';
            }
        }
    } catch (e) {
        console.error('轮询同步状态失败:', e);
        setTimeout(() => pollSyncStatus(playlistId), 5000);
    }
}

// 插入变量
function insertVar(varName) {
    const textarea = document.querySelector('textarea[name="desc_template"]');
    const text = '${' + varName + '}';
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    textarea.value = textarea.value.substring(0, start) + text + textarea.value.substring(end);
    textarea.focus();
    textarea.selectionStart = textarea.selectionEnd = start + text.length;
}

// 保存模板配置
async function saveTemplates() {
    const config = {
        templates: {
            title: document.querySelector('input[name="title_template"]').value,
            description: document.querySelector('textarea[name="desc_template"]').value,
        }
    };
    
    try {
        const resp = await fetch('/bilibili/config', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });
        const data = await resp.json();
        
        if (data.success) {
            alert('✓ 模板配置已保存到 config/upload.yaml');
        } else {
            alert('保存失败: ' + data.error);
        }
    } catch (e) {
        alert('保存失败: ' + e);
    }
}

// =============================================================================
// 审核退回管理
// =============================================================================

let rejectedVideos = [];

async function loadRejectedVideos() {
    const container = document.getElementById('rejected-container');
    const btn = document.getElementById('btn-load-rejected');
    btn.disabled = true;
    btn.textContent = '加载中...';
    container.innerHTML = '<p class="text-gray-500">正在获取退回稿件...</p>';
    
    try {
        const resp = await fetch('/bilibili/rejected');
        const data = await resp.json();
        
        if (!data.success) {
            container.innerHTML = `<p class="text-red-500">获取失败: ${data.error}</p>`;
            return;
        }
        
        rejectedVideos = data.videos;
        renderRejected();
        
    } catch (e) {
        container.innerHTML = `<p class="text-red-500">加载失败: ${e}</p>`;
    } finally {
        btn.disabled = false;
        btn.textContent = '刷新退回列表';
    }
}

function renderRejected() {
    const container = document.getElementById('rejected-container');
    if (rejectedVideos.length === 0) {
        container.innerHTML = '<p class="text-green-600">没有被退回的稿件</p>';
        return;
    }
    
    // 默认只显示可修复的，全片违规隐藏
    const showAll = document.getElementById('show-all-rejected')?.checked;
    const filtered = showAll ? rejectedVideos : rejectedVideos.filter(v => v.fixable);
    const hiddenCount = rejectedVideos.length - filtered.length;
    
    let html = `<p class="text-sm text-gray-500 mb-3">共 ${rejectedVideos.length} 个退回稿件</p>`;
    
    if (hiddenCount > 0) {
        html += `<div class="text-sm text-gray-400 mb-3">
            <label class="cursor-pointer select-none">
                <input type="checkbox" id="show-all-rejected" onchange="renderRejected()" ${showAll ? 'checked' : ''}>
                显示 ${hiddenCount} 个全片违规（无法自动修复）
            </label>
        </div>`;
    }
    
    html += '<div class="space-y-4">';
    
    for (const v of filtered) {
        const statusBadge = v.fixable
            ? '<span class="px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">可修复</span>'
            : v.is_full_video
                ? '<span class="px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">全片违规</span>'
                : '<span class="px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600">未知</span>';
        
        // 违规详情
        let problemsHtml = '';
        for (const p of v.problems) {
            problemsHtml += `<div class="text-sm text-gray-600 mt-1">`;
            problemsHtml += `<span class="text-red-600 font-medium">原因:</span> ${escapeHtml(p.reason)}`;
            if (p.violation_time) {
                problemsHtml += `<br><span class="text-gray-500">时间:</span> ${escapeHtml(p.violation_time)}`;
                if (p.time_ranges.length > 0) {
                    const rangesStr = p.time_ranges.map(r => `${formatSec(r[0])}-${formatSec(r[1])}`).join(', ');
                    problemsHtml += ` <span class="text-gray-400">(${rangesStr})</span>`;
                }
            }
            if (p.is_full_video) {
                problemsHtml += `<br><span class="text-red-500">位置: ${escapeHtml(p.violation_position)}（全片违规，无法自动修复）</span>`;
            }
            if (p.modify_advise) {
                problemsHtml += `<br><span class="text-gray-500">建议:</span> ${escapeHtml(p.modify_advise)}`;
            }
            problemsHtml += '</div>';
        }
        
        // 修复按钮/状态
        let actionHtml = '';
        if (v.fixable) {
            const fixStatus = v.fix_status;
            if (fixStatus === 'masking' || fixStatus === 'uploading') {
                actionHtml = `<div id="fix-status-${v.aid}" class="mt-2">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-700">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                        处理中...
                    </span>
                </div>`;
                setTimeout(() => pollFixStatus(v.aid), 2000);
            } else if (fixStatus === 'completed') {
                actionHtml = `<div id="fix-status-${v.aid}" class="mt-2">
                    <span class="text-green-600 text-sm">✓ 已修复</span>
                </div>`;
            } else {
                actionHtml = `<div id="fix-status-${v.aid}" class="mt-2">
                    <button onclick="startFix(${v.aid})" class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600">
                        自动修复
                    </button>
                </div>`;
            }
        }
        
        html += `
            <div class="border rounded-lg p-4" id="rejected-card-${v.aid}">
                <div class="flex justify-between items-start">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            ${statusBadge}
                            <span class="text-xs text-gray-400">av${v.aid}</span>
                        </div>
                        <h3 class="text-sm font-medium text-gray-900 truncate">${escapeHtml(v.title)}</h3>
                        ${problemsHtml}
                    </div>
                    <div class="ml-4 flex-shrink-0">
                        ${actionHtml}
                    </div>
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    container.innerHTML = html;
}

async function startFix(aid) {
    const video = rejectedVideos.find(v => v.aid === aid);
    if (!video) return;
    
    if (!confirm(`确认修复 av${aid}?\n\n标题: ${video.title}\n违规区间: ${video.all_ranges.map(r => formatSec(r[0])+'-'+formatSec(r[1])).join(', ')}\n\n将遮罩违规片段并重新上传`)) {
        return;
    }
    
    const statusDiv = document.getElementById(`fix-status-${aid}`);
    statusDiv.innerHTML = `<span class="text-gray-500 text-sm">正在启动...</span>`;
    
    try {
        const resp = await fetch(`/bilibili/fix/${aid}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                violation_ranges: video.all_ranges,
                margin: 1.0,
                mask_text: '此处内容因合规要求已被遮罩',
                bvid: video.bvid || '',
            })
        });
        const data = await resp.json();
        
        if (data.success) {
            statusDiv.innerHTML = `
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-700">
                    <svg class="animate-spin -ml-1 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                    正在处理...
                </span>
                <p class="text-xs text-gray-400 mt-1">视频: ${data.video_path}</p>
            `;
            pollFixStatus(aid);
        } else if (data.need_path) {
            // 需要手动指定路径
            const path = prompt('未找到本地视频文件，请输入视频文件的绝对路径:');
            if (path) {
                // 重试并传入路径
                const resp2 = await fetch(`/bilibili/fix/${aid}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        violation_ranges: video.all_ranges,
                        margin: 1.0,
                        mask_text: '此处内容因合规要求已被遮罩',
                        bvid: video.bvid || '',
                        video_path: path,
                    })
                });
                const data2 = await resp2.json();
                if (data2.success) {
                    statusDiv.innerHTML = `
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-700">
                            <svg class="animate-spin -ml-1 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                            正在处理...
                        </span>`;
                    pollFixStatus(aid);
                } else {
                    statusDiv.innerHTML = `<span class="text-red-500 text-sm">${data2.error}</span>`;
                }
            } else {
                statusDiv.innerHTML = `<button onclick="startFix(${aid})" class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600">自动修复</button>`;
            }
        } else {
            statusDiv.innerHTML = `<span class="text-red-500 text-sm">${data.error}</span>`;
        }
    } catch (e) {
        statusDiv.innerHTML = `<span class="text-red-500 text-sm">启动失败: ${e}</span>`;
    }
}

async function pollFixStatus(aid) {
    const statusDiv = document.getElementById(`fix-status-${aid}`);
    if (!statusDiv) return;
    
    try {
        const resp = await fetch(`/bilibili/fix/${aid}/status`);
        const data = await resp.json();
        
        const statusMap = {
            'pending': { text: '等待中...', color: 'gray', spin: true },
            'masking': { text: '正在遮罩处理...', color: 'blue', spin: true },
            'uploading': { text: '正在上传替换...', color: 'blue', spin: true },
            'completed': { text: '✓ 修复完成', color: 'green', spin: false },
            'failed': { text: '✗ ' + (data.message || '失败'), color: 'red', spin: false },
        };
        
        const info = statusMap[data.status] || { text: data.message || data.status, color: 'gray', spin: false };
        
        const spinnerSvg = info.spin
            ? `<svg class="animate-spin -ml-1 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>`
            : '';
        
        statusDiv.innerHTML = `
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-${info.color}-100 text-${info.color}-700">
                ${spinnerSvg}${escapeHtml(info.text)}
            </span>
            ${data.message && data.status !== 'completed' && data.status !== 'none' ? `<p class="text-xs text-gray-400 mt-1">${escapeHtml(data.message)}</p>` : ''}
        `;
        
        // 继续轮询（如果还在进行中）
        if (['pending', 'masking', 'uploading'].includes(data.status)) {
            setTimeout(() => pollFixStatus(aid), 3000);
        } else if (data.status === 'failed') {
            // 失败后显示重试按钮
            statusDiv.innerHTML += `
                <button onclick="startFix(${aid})" class="ml-2 px-2 py-0.5 text-xs border border-gray-300 rounded hover:bg-gray-50">
                    重试
                </button>
            `;
        }
    } catch (e) {
        console.error('轮询修复状态失败:', e);
        setTimeout(() => pollFixStatus(aid), 5000);
    }
}

function formatSec(sec) {
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60);
    return `${m}:${s.toString().padStart(2, '0')}`;
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// 保存默认设置
async function saveSettings() {
    const config = {
        copyright: parseInt(document.querySelector('select[name="copyright"]').value),
        default_tid: parseInt(document.querySelector('input[name="default_tid"]').value),
        default_tags: document.querySelector('input[name="default_tags"]').value.split(',').map(t => t.trim()).filter(t => t),
        auto_cover: document.getElementById('auto_cover').checked,
        season_id: document.querySelector('select[name="season_id"]').value || null,
    };
    
    try {
        const resp = await fetch('/bilibili/config', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });
        const data = await resp.json();
        
        if (data.success) {
            alert('✓ 上传设置已保存到 config/upload.yaml');
        } else {
            alert('保存失败: ' + data.error);
        }
    } catch (e) {
        alert('保存失败: ' + e);
    }
}
</script>
{% endblock %}
