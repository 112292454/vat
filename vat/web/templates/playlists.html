{% extends "base.html" %}

{% block title %}Playlists - VAT Manager{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- é¡µé¢æ ‡é¢˜å’Œæ“ä½œ -->
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800">Playlist ç®¡ç†</h1>
        <button onclick="showAddPlaylistModal()" 
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
            + æ·»åŠ  Playlist
        </button>
    </div>

    <!-- Playlist åˆ—è¡¨ -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ ‡é¢˜</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">é¢‘é“</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">è§†é¢‘æ•°</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">è¿›åº¦</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">æœ€ååŒæ­¥</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="playlist-list">
                {% for pl in playlists %}
                <tr class="hover:bg-gray-50" data-playlist-id="{{ pl.id }}">
                    <td class="px-6 py-4">
                        <a href="/playlists/{{ pl.id }}" class="text-blue-600 hover:underline font-medium">
                            {{ pl.title or pl.id }}
                        </a>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600">{{ pl.channel or '-' }}</td>
                    <td class="px-6 py-4 text-sm">{{ pl.video_count or 0 }}</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="w-24 bg-gray-200 rounded-full h-2 mr-2">
                                <div class="bg-green-500 h-2 rounded-full" style="width: {{ pl.progress_percent }}%"></div>
                            </div>
                            <span class="text-sm text-gray-600">{{ pl.completed }}/{{ pl.video_count }}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600 sync-status">{{ pl.last_synced_at|format_datetime }}</td>
                    <td class="px-6 py-4 text-sm">
                        <div class="flex space-x-2">
                            <button onclick="syncPlaylist('{{ pl.id }}')" 
                                    class="text-blue-600 hover:text-blue-800">åŒæ­¥</button>
                            <button onclick="processPlaylist('{{ pl.id }}')" 
                                    class="text-green-600 hover:text-green-800">å¤„ç†</button>
                            <button onclick="deletePlaylist('{{ pl.id }}', '{{ pl.title|e }}')" 
                                    class="text-red-600 hover:text-red-800">åˆ é™¤</button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                        æ²¡æœ‰ Playlistï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ 
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- æ·»åŠ  Playlist æ¨¡æ€æ¡† -->
<div id="add-playlist-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
        <h2 class="text-xl font-bold mb-4">æ·»åŠ  Playlist</h2>
        <form id="add-playlist-form" onsubmit="addPlaylist(event)">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">YouTube Playlist URL</label>
                <input type="url" name="url" required
                       placeholder="https://www.youtube.com/playlist?list=..."
                       class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" name="auto_sync" checked class="mr-2">
                    <span class="text-sm text-gray-700">è‡ªåŠ¨åŒæ­¥è§†é¢‘åˆ—è¡¨</span>
                </label>
            </div>
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" name="fetch_upload_dates" checked class="mr-2">
                    <span class="text-sm text-gray-700">è·å–å‘å¸ƒæ—¥æœŸï¼ˆç”¨äºæŒ‰æ—¶é—´æ’åºï¼Œåå°æ‰§è¡Œï¼‰</span>
                </label>
                <p class="text-xs text-gray-500 mt-1 ml-5">æ¯ä¸ªè§†é¢‘éœ€å•ç‹¬è¯·æ±‚ï¼Œå°†åœ¨åå°å¼‚æ­¥æ‰§è¡Œ</p>
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="hideAddPlaylistModal()" 
                        class="px-4 py-2 text-gray-600 hover:text-gray-800">å–æ¶ˆ</button>
                <button type="submit" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">æ·»åŠ </button>
            </div>
        </form>
    </div>
</div>

<script>
function showAddPlaylistModal() {
    document.getElementById('add-playlist-modal').classList.remove('hidden');
}

function hideAddPlaylistModal() {
    document.getElementById('add-playlist-modal').classList.add('hidden');
}

async function addPlaylist(event) {
    event.preventDefault();
    const form = event.target;
    const url = form.querySelector('[name="url"]').value;
    const autoSync = form.querySelector('[name="auto_sync"]').checked;
    const fetchDates = form.querySelector('[name="fetch_upload_dates"]').checked;
    const submitBtn = form.querySelector('button[type="submit"]');
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'æ­£åœ¨è·å–ä¿¡æ¯...';
    
    try {
        const response = await fetch('/api/playlists', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({url: url, auto_sync: autoSync, fetch_upload_dates: fetchDates})
        });
        
        if (response.ok) {
            const result = await response.json();
            hideAddPlaylistModal();
            showToast('å·²å¯åŠ¨åå°åŒæ­¥ï¼Œå¯åœ¨åˆ—è¡¨ä¸­æŸ¥çœ‹è¿›åº¦', 'info');
            setTimeout(() => location.reload(), 1000);
        } else {
            const error = await response.json();
            showToast('æ·»åŠ å¤±è´¥: ' + (error.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = 'æ·»åŠ ';
        }
    } catch (e) {
        showToast('è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'æ·»åŠ ';
    }
}

async function syncPlaylist(playlistId) {
    if (!confirm('ç¡®å®šè¦åŒæ­¥æ­¤ Playlist?')) return;
    
    try {
        const response = await fetch(`/api/playlists/${playlistId}/sync`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({fetch_upload_dates: true})
        });
        if (response.ok) {
            showToast('å·²å¯åŠ¨åå°åŒæ­¥', 'info');
            setTimeout(() => location.reload(), 1000);
        } else {
            const error = await response.json();
            showToast('åŒæ­¥å¤±è´¥: ' + (error.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
    } catch (e) {
        showToast('è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
    }
}

// æ£€æŸ¥åŒæ­¥çŠ¶æ€å¹¶æ›´æ–° UI
async function checkSyncStatus(playlistId, statusCell, originalContent) {
    try {
        const response = await fetch(`/api/playlists/${playlistId}/sync-status`);
        if (response.ok) {
            const status = await response.json();
            if (status.status === 'syncing') {
                statusCell.innerHTML = `<span class="text-blue-600">ğŸ”„ ${status.message}</span>`;
                setTimeout(() => checkSyncStatus(playlistId, statusCell, originalContent), 2000);
            } else if (status.status === 'completed') {
                statusCell.innerHTML = `<span class="text-green-600">âœ“ ${status.message}</span>`;
                // å®Œæˆåä¸å†è½®è¯¢ï¼Œ3ç§’åæ¢å¤åŸå§‹å†…å®¹
                setTimeout(() => { statusCell.innerHTML = originalContent; }, 3000);
            } else if (status.status === 'failed') {
                statusCell.innerHTML = `<span class="text-red-600">âœ— ${status.message}</span>`;
                // å¤±è´¥åä¸å†è½®è¯¢
            }
            // idle çŠ¶æ€ä¸åšä»»ä½•å¤„ç†ï¼Œä¸å†è½®è¯¢
        }
    } catch (e) {
        console.error('æ£€æŸ¥åŒæ­¥çŠ¶æ€å¤±è´¥:', e);
    }
}

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ‰€æœ‰ playlist çš„åŒæ­¥çŠ¶æ€
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[data-playlist-id]').forEach(row => {
        const playlistId = row.dataset.playlistId;
        const statusCell = row.querySelector('.sync-status');
        if (statusCell) {
            const originalContent = statusCell.innerHTML;
            // å…ˆæ£€æŸ¥ä¸€æ¬¡ï¼Œåªæœ‰ syncing çŠ¶æ€æ‰ä¼šç»§ç»­è½®è¯¢
            checkSyncStatus(playlistId, statusCell, originalContent);
        }
    });
});

function processPlaylist(playlistId) {
    location.href = `/tasks/new?playlist=${playlistId}`;
}

async function deletePlaylist(playlistId, title) {
    // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
    showDeleteDialog(playlistId, title);
}

function showDeleteDialog(playlistId, title) {
    // åˆ›å»ºæ¨¡æ€æ¡†
    const modal = document.createElement('div');
    modal.id = 'delete-modal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-bold mb-4">åˆ é™¤ Playlist</h3>
            <p class="mb-4">ç¡®å®šè¦åˆ é™¤ "<span class="font-medium">${title}</span>"ï¼Ÿ</p>
            <label class="flex items-center mb-4 cursor-pointer">
                <input type="checkbox" id="delete-videos-checkbox" class="mr-2 w-4 h-4">
                <span class="text-red-600">åŒæ—¶åˆ é™¤æ‰€æœ‰å…³è”çš„è§†é¢‘</span>
            </label>
            <p class="text-sm text-gray-500 mb-4">âš ï¸ å‹¾é€‰åå°†æ°¸ä¹…åˆ é™¤è§†é¢‘åŠå…¶æ‰€æœ‰å¤„ç†æ–‡ä»¶</p>
            <div class="flex justify-end gap-2">
                <button onclick="closeDeleteDialog()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">å–æ¶ˆ</button>
                <button onclick="confirmDelete('${playlistId}')" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">åˆ é™¤</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function closeDeleteDialog() {
    const modal = document.getElementById('delete-modal');
    if (modal) modal.remove();
}

async function confirmDelete(playlistId) {
    const deleteVideos = document.getElementById('delete-videos-checkbox')?.checked || false;
    closeDeleteDialog();
    
    try {
        const url = `/api/playlists/${playlistId}?delete_videos=${deleteVideos}`;
        const response = await fetch(url, {method: 'DELETE'});
        if (response.ok) {
            const result = await response.json();
            if (deleteVideos && result.deleted_videos > 0) {
                showToast(`åˆ é™¤æˆåŠŸï¼Œå…±åˆ é™¤ ${result.deleted_videos} ä¸ªè§†é¢‘`, 'success');
            } else {
                showToast('åˆ é™¤æˆåŠŸ', 'success');
            }
            setTimeout(() => location.reload(), 1000);
        } else {
            const error = await response.json();
            showToast('åˆ é™¤å¤±è´¥: ' + (error.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
    } catch (e) {
        showToast('è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
    }
}
</script>
{% endblock %}
