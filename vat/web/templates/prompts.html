{% extends "base.html" %}

{% block title %}Custom Prompts - VAT Manager{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Custom Prompts</h1>
    <button onclick="showCreateModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
        + æ–°å»º Prompt
    </button>
</div>

<!-- Prompt åˆ—è¡¨ -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- ç¿»è¯‘ Prompts -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b">
            <h2 class="text-lg font-semibold">ç¿»è¯‘ Prompts</h2>
            <p class="text-sm text-gray-500">ç”¨äº LLM ç¿»è¯‘é˜¶æ®µ</p>
        </div>
        <div class="divide-y" id="translate-prompts">
            <!-- åŠ¨æ€åŠ è½½ -->
        </div>
    </div>
    
    <!-- ä¼˜åŒ– Prompts -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b">
            <h2 class="text-lg font-semibold">ä¼˜åŒ– Prompts</h2>
            <p class="text-sm text-gray-500">ç”¨äºå­—å¹•ä¼˜åŒ–é˜¶æ®µ</p>
        </div>
        <div class="divide-y" id="optimize-prompts">
            <!-- åŠ¨æ€åŠ è½½ -->
        </div>
    </div>
</div>

<!-- å½“å‰é€‰æ‹©çŠ¶æ€ -->
<div class="mt-6 bg-white rounded-lg shadow p-6">
    <h2 class="text-lg font-semibold mb-4">å½“å‰ä½¿ç”¨çš„ Prompt</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ç¿»è¯‘ Prompt</label>
            <select id="current-translate-prompt" onchange="setCurrentPrompt('translate', this.value)"
                    class="w-full border rounded-lg px-3 py-2">
                <option value="">ï¼ˆä¸ä½¿ç”¨ï¼‰</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ä¼˜åŒ– Prompt</label>
            <select id="current-optimize-prompt" onchange="setCurrentPrompt('optimize', this.value)"
                    class="w-full border rounded-lg px-3 py-2">
                <option value="">ï¼ˆä¸ä½¿ç”¨ï¼‰</option>
            </select>
        </div>
    </div>
    <p class="text-sm text-gray-500 mt-2">
        ğŸ’¡ è¿™é‡Œé€‰æ‹©çš„ Prompt å°†ä½œä¸ºé»˜è®¤ä½¿ç”¨ã€‚Playlist å¯å•ç‹¬é…ç½®ä¸“å± Promptã€‚
    </p>
</div>

<!-- æ–°å»º/ç¼–è¾‘æ¨¡æ€æ¡† -->
<div id="prompt-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
        <div class="px-6 py-4 border-b flex justify-between items-center">
            <h3 class="text-lg font-semibold" id="modal-title">æ–°å»º Prompt</h3>
            <button onclick="hideModal()" class="text-gray-400 hover:text-gray-600">&times;</button>
        </div>
        <form onsubmit="savePrompt(event)" class="p-6">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">åç§°</label>
                    <input type="text" name="name" id="prompt-name" required
                           class="w-full border rounded-lg px-3 py-2" placeholder="å¦‚: fubuki">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç±»å‹</label>
                    <select name="type" id="prompt-type" class="w-full border rounded-lg px-3 py-2">
                        <option value="translate">ç¿»è¯‘</option>
                        <option value="optimize">ä¼˜åŒ–</option>
                    </select>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">å†…å®¹ (Markdown)</label>
                <textarea name="content" id="prompt-content" rows="15" required
                          class="w-full border rounded-lg px-3 py-2 font-mono text-sm"
                          placeholder="# ç¿»è¯‘è¦æ±‚&#10;&#10;## æœ¯è¯­è¡¨&#10;- é…ä¿¡: ç›´æ’­&#10;&#10;## ç¿»è¯‘é£æ ¼&#10;- ä¿æŒåŸæœ‰è¯­æ°”"></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">å–æ¶ˆ</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>

<script>
let prompts = [];
let editingPrompt = null;

// åŠ è½½ Prompts åˆ—è¡¨
async function loadPrompts() {
    try {
        const response = await fetch('/api/prompts');
        const data = await response.json();
        prompts = data.prompts;
        renderPrompts();
        updateSelectors();
    } catch (e) {
        console.error('åŠ è½½ Prompts å¤±è´¥:', e);
    }
}

function renderPrompts() {
    const translateContainer = document.getElementById('translate-prompts');
    const optimizeContainer = document.getElementById('optimize-prompts');
    
    const translatePrompts = prompts.filter(p => p.type === 'translate');
    const optimizePrompts = prompts.filter(p => p.type === 'optimize');
    
    translateContainer.innerHTML = translatePrompts.length ? 
        translatePrompts.map(p => renderPromptItem(p)).join('') :
        '<div class="px-6 py-4 text-gray-500 text-sm">æš‚æ— ç¿»è¯‘ Prompt</div>';
    
    optimizeContainer.innerHTML = optimizePrompts.length ?
        optimizePrompts.map(p => renderPromptItem(p)).join('') :
        '<div class="px-6 py-4 text-gray-500 text-sm">æš‚æ— ä¼˜åŒ– Prompt</div>';
}

function renderPromptItem(p) {
    return `
        <div class="px-6 py-3 flex items-center justify-between hover:bg-gray-50">
            <div>
                <span class="font-medium">${p.name}</span>
                <span class="text-sm text-gray-500 ml-2">${formatSize(p.size)}</span>
            </div>
            <div class="flex space-x-2">
                <button onclick="editPrompt('${p.type}', '${p.name}')" 
                        class="text-blue-600 hover:text-blue-800 text-sm">ç¼–è¾‘</button>
                <button onclick="deletePrompt('${p.type}', '${p.name}')" 
                        class="text-red-600 hover:text-red-800 text-sm">åˆ é™¤</button>
            </div>
        </div>
    `;
}

function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    return (bytes / 1024).toFixed(1) + ' KB';
}

function updateSelectors() {
    const translateSelect = document.getElementById('current-translate-prompt');
    const optimizeSelect = document.getElementById('current-optimize-prompt');
    
    // ä¿ç•™ç¬¬ä¸€ä¸ªé€‰é¡¹
    translateSelect.innerHTML = '<option value="">ï¼ˆä¸ä½¿ç”¨ï¼‰</option>';
    optimizeSelect.innerHTML = '<option value="">ï¼ˆä¸ä½¿ç”¨ï¼‰</option>';
    
    prompts.forEach(p => {
        const option = `<option value="${p.name}">${p.name}</option>`;
        if (p.type === 'translate') {
            translateSelect.innerHTML += option;
        } else {
            optimizeSelect.innerHTML += option;
        }
    });
    
    // æ¢å¤å½“å‰é€‰æ‹©
    const savedTranslate = localStorage.getItem('vat_current_translate_prompt');
    const savedOptimize = localStorage.getItem('vat_current_optimize_prompt');
    if (savedTranslate) translateSelect.value = savedTranslate;
    if (savedOptimize) optimizeSelect.value = savedOptimize;
}

function setCurrentPrompt(type, name) {
    localStorage.setItem(`vat_current_${type}_prompt`, name);
}

function showCreateModal() {
    editingPrompt = null;
    document.getElementById('modal-title').textContent = 'æ–°å»º Prompt';
    document.getElementById('prompt-name').value = '';
    document.getElementById('prompt-name').disabled = false;
    document.getElementById('prompt-type').value = 'translate';
    document.getElementById('prompt-type').disabled = false;
    document.getElementById('prompt-content').value = '';
    document.getElementById('prompt-modal').classList.remove('hidden');
}

async function editPrompt(type, name) {
    try {
        const response = await fetch(`/api/prompts/${type}/${name}`);
        if (!response.ok) throw new Error('è·å–å¤±è´¥');
        
        const data = await response.json();
        editingPrompt = { type, name };
        
        document.getElementById('modal-title').textContent = 'ç¼–è¾‘ Prompt';
        document.getElementById('prompt-name').value = name;
        document.getElementById('prompt-name').disabled = true;
        document.getElementById('prompt-type').value = type;
        document.getElementById('prompt-type').disabled = true;
        document.getElementById('prompt-content').value = data.content;
        document.getElementById('prompt-modal').classList.remove('hidden');
    } catch (e) {
        showToast('è·å– Prompt å¤±è´¥: ' + e.message, 'error');
    }
}

function hideModal() {
    document.getElementById('prompt-modal').classList.add('hidden');
}

async function savePrompt(event) {
    event.preventDefault();
    
    const name = document.getElementById('prompt-name').value.trim();
    const type = document.getElementById('prompt-type').value;
    const content = document.getElementById('prompt-content').value;
    
    if (!name || !content) {
        showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'warning');
        return;
    }
    
    try {
        const method = editingPrompt ? 'PUT' : 'POST';
        const response = await fetch(`/api/prompts/${type}/${name}`, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'ä¿å­˜å¤±è´¥');
        }
        
        hideModal();
        loadPrompts();
    } catch (e) {
        showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
    }
}

async function deletePrompt(type, name) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤ Prompt "${name}" å—ï¼Ÿ`)) return;
    
    try {
        const response = await fetch(`/api/prompts/${type}/${name}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('åˆ é™¤å¤±è´¥');
        loadPrompts();
    } catch (e) {
        showToast('åˆ é™¤å¤±è´¥: ' + e.message, 'error');
    }
}

// åˆå§‹åŒ–
loadPrompts();
</script>
{% endblock %}
