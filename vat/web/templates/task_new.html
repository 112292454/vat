{% extends "base.html" %}

{% block title %}新建任务 - VAT Manager{% endblock %}

{% block content %}
<div class="space-y-6">
    <a href="{{ back_url|default('/tasks', true) }}" class="text-blue-600 hover:text-blue-800">&larr; 返回</a>
    
    <div class="bg-white rounded-lg shadow p-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">新建处理任务</h1>
        
        <form id="task-form" onsubmit="submitTask(event)">
            <!-- 视频选择 -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">选择视频</label>
                
                {% if playlist_id %}
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <p class="text-blue-800">已选择 Playlist: <strong>{{ playlist_title }}</strong></p>
                    <p class="text-blue-600 text-sm">包含 {{ playlist_video_count }} 个视频</p>
                    <input type="hidden" name="playlist_id" value="{{ playlist_id }}">
                </div>
                {% endif %}
                
                {% if truncated %}
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3 text-sm text-yellow-800">
                    ⚠️ 视频数量过多，仅显示前 {{ videos|length }} 个。建议从<a href="/playlists" class="text-blue-600 hover:underline">Playlist 页面</a>或<a href="/" class="text-blue-600 hover:underline">首页</a>选择视频后进入此页面。
                </div>
                {% endif %}
                
                <!-- 搜索框 -->
                <div class="mb-2">
                    <input type="text" id="video-search" placeholder="搜索视频标题..." 
                           class="w-full px-3 py-2 border rounded-lg text-sm"
                           oninput="filterVideos()">
                </div>
                
                <div id="video-list" class="space-y-2 max-h-80 overflow-y-auto border rounded-lg p-3">
                    {% for video in videos %}
                    <label class="video-item flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer"
                           data-title="{{ (video.title or video.id) | lower }}"
                           data-playlist="{{ video.playlist_id or '' }}">
                        <input type="checkbox" name="video_ids" value="{{ video.id }}" 
                               class="mr-3" {% if video.selected %}checked{% endif %}>
                        <span class="text-sm flex-1 truncate">{{ video.title or video.id }}</span>
                        <span class="ml-2 text-xs text-gray-500 whitespace-nowrap">{{ video.progress_text }}</span>
                    </label>
                    {% else %}
                    <p class="text-gray-500 text-center py-4">没有可处理的视频</p>
                    {% endfor %}
                </div>
                
                <div class="mt-2 flex flex-wrap gap-3 text-sm">
                    <button type="button" onclick="selectAll()" class="text-blue-600 hover:underline">全选</button>
                    <button type="button" onclick="selectNone()" class="text-blue-600 hover:underline">取消全选</button>
                    <button type="button" onclick="selectPending()" class="text-blue-600 hover:underline">选择待处理</button>
                    <button type="button" onclick="selectVisible()" class="text-blue-600 hover:underline">选择可见</button>
                </div>
            </div>
            
            <!-- 阶段选择 -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">执行阶段</label>
                <div class="space-y-3">
                    <!-- 下载 -->
                    <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" name="steps" value="download" class="mr-2" checked>
                        <span class="text-sm font-medium">下载</span>
                    </label>
                    
                    <!-- ASR 阶段组 -->
                    <div class="border rounded-lg">
                        <label class="flex items-center p-3 hover:bg-gray-50 cursor-pointer border-b">
                            <input type="checkbox" id="asr-group" class="mr-2" checked 
                                   onchange="toggleSubSteps('asr', this.checked)">
                            <span class="text-sm font-medium">ASR (语音识别)</span>
                        </label>
                        <div class="pl-8 py-2 bg-gray-50 space-y-1">
                            <label class="flex items-center p-2 hover:bg-gray-100 cursor-pointer rounded">
                                <input type="checkbox" name="steps" value="whisper" class="mr-2 asr-sub" checked
                                       onchange="updateGroupCheckbox('asr')">
                                <span class="text-sm">Whisper (语音转文字)</span>
                            </label>
                            <label class="flex items-center p-2 hover:bg-gray-100 cursor-pointer rounded">
                                <input type="checkbox" name="steps" value="split" class="mr-2 asr-sub" checked
                                       onchange="updateGroupCheckbox('asr')">
                                <span class="text-sm">Split (智能断句)</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 翻译阶段组 -->
                    <div class="border rounded-lg">
                        <label class="flex items-center p-3 hover:bg-gray-50 cursor-pointer border-b">
                            <input type="checkbox" id="translate-group" class="mr-2" checked
                                   onchange="toggleSubSteps('translate', this.checked)">
                            <span class="text-sm font-medium">翻译</span>
                        </label>
                        <div class="pl-8 py-2 bg-gray-50 space-y-1">
                            <label class="flex items-center p-2 hover:bg-gray-100 cursor-pointer rounded">
                                <input type="checkbox" name="steps" value="optimize" class="mr-2 translate-sub" checked
                                       onchange="updateGroupCheckbox('translate')">
                                <span class="text-sm">Optimize (提示词优化)</span>
                            </label>
                            <label class="flex items-center p-2 hover:bg-gray-100 cursor-pointer rounded">
                                <input type="checkbox" name="steps" value="translate" class="mr-2 translate-sub" checked
                                       onchange="updateGroupCheckbox('translate')">
                                <span class="text-sm">Translate (翻译)</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 嵌入字幕 -->
                    <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" name="steps" value="embed" class="mr-2" checked>
                        <span class="text-sm font-medium">嵌入字幕</span>
                    </label>
                    
                    <!-- 上传 -->
                    <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" name="steps" value="upload" class="mr-2"
                               onchange="updateUploadScheduleVisibility()">
                        <span class="text-sm font-medium">上传到B站</span>
                        <span class="ml-2 text-xs text-gray-500">(需要先登录B站)</span>
                    </label>
                    
                    <!-- 定时上传设置（仅当 upload 是唯一选中的阶段时显示） -->
                    <div id="upload-schedule-section" class="hidden mt-2 ml-6 p-4 bg-orange-50 border border-orange-200 rounded-lg">
                        <label class="flex items-center mb-3">
                            <input type="checkbox" id="enable-schedule" class="mr-2" onchange="toggleScheduleOptions()">
                            <span class="text-sm font-medium text-orange-800">定时上传（每次触发上传一个视频）</span>
                        </label>
                        
                        <div id="schedule-options" class="hidden space-y-3">
                            <!-- 模式选择 -->
                            <div>
                                <select id="schedule-mode" class="border rounded-lg px-3 py-2 text-sm w-full max-w-xs"
                                        onchange="updateScheduleMode()">
                                    <option value="daily">每天在指定时刻</option>
                                    <option value="interval">每隔 N 小时</option>
                                    <option value="cron">高级 (cron 表达式)</option>
                                </select>
                            </div>
                            
                            <!-- 模式1: 每天指定时刻 -->
                            <div id="mode-daily" class="space-y-2">
                                <p class="text-xs text-gray-600">选择每天上传的时间点（可多选，每个时间点上传一个视频）：</p>
                                <div id="time-slots" class="flex flex-wrap gap-2">
                                    <input type="time" class="time-slot border rounded px-2 py-1 text-sm" value="12:00">
                                </div>
                                <button type="button" onclick="addTimeSlot()"
                                        class="text-xs text-blue-600 hover:underline">+ 添加时间点</button>
                                <p class="text-xs text-gray-500">生成的 cron: <code id="daily-cron-preview" class="bg-gray-100 px-1 rounded">-</code></p>
                            </div>
                            
                            <!-- 模式2: 每隔N小时 -->
                            <div id="mode-interval" class="hidden space-y-2">
                                <div class="flex items-center space-x-2">
                                    <span class="text-sm">每隔</span>
                                    <select id="interval-hours" class="border rounded px-2 py-1 text-sm"
                                            onchange="updateIntervalCron()">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="6">6</option>
                                        <option value="8">8</option>
                                        <option value="12" selected>12</option>
                                        <option value="24">24</option>
                                        <option value="48">48</option>
                                    </select>
                                    <span class="text-sm">小时上传一个</span>
                                </div>
                                <p class="text-xs text-gray-500">生成的 cron: <code id="interval-cron-preview" class="bg-gray-100 px-1 rounded">-</code></p>
                            </div>
                            
                            <!-- 模式3: 高级 cron -->
                            <div id="mode-cron" class="hidden space-y-2">
                                <input type="text" id="cron-input" placeholder="0 12,18 * * *"
                                       class="border rounded-lg px-3 py-2 text-sm w-full max-w-xs font-mono"
                                       oninput="validateCronInput()">
                                <p class="text-xs text-gray-500">
                                    格式: 分 时 日 月 星期。示例: <code>0 12,18 * * *</code> = 每天12点和18点；
                                    <code>0 */6 * * *</code> = 每6小时
                                </p>
                                <p id="cron-validation" class="text-xs hidden"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- GPU 设置 -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">GPU 设置</label>
                <select name="gpu_device" class="border rounded-lg px-3 py-2 w-full max-w-xs">
                    <option value="auto">自动选择 (推荐)</option>
                    <option value="cuda:0">GPU 0</option>
                    <option value="cuda:1">GPU 1</option>
                    <option value="cpu">仅 CPU</option>
                </select>
            </div>
            
            <!-- 并发设置 -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">并发数量</label>
                <div class="flex items-center space-x-3">
                    <select name="concurrency" class="border rounded-lg px-3 py-2 w-full max-w-xs">
                        <option value="1">1 (串行，默认)</option>
                        <option value="2">2 个视频并行</option>
                        <option value="3">3 个视频并行</option>
                        <option value="4">4 个视频并行</option>
                        <option value="5">5 个视频并行</option>
                    </select>
                </div>
                <p class="text-xs text-gray-500 mt-1">⚠️ 并行处理会增加 GPU 显存占用，建议根据显存大小设置。包含 GPU 步骤(whisper/embed)时建议不超过 2。</p>
            </div>
            
            <!-- 其他选项 -->
            <div class="mb-6">
                <label class="flex items-center">
                    <input type="checkbox" name="force" class="mr-2">
                    <span class="text-sm text-gray-700">强制重新处理 (即使已完成)</span>
                </label>
            </div>
            
            <!-- 提交按钮 -->
            <div class="flex items-center space-x-4">
                <button type="submit" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    开始执行
                </button>
                <button type="button" onclick="generateCLI()" 
                        class="px-4 py-2 text-gray-600 hover:text-gray-800 border rounded-lg">
                    生成 CLI 命令
                </button>
            </div>
        </form>
        
        <!-- CLI 命令显示区域 -->
        <div id="cli-output" class="hidden mt-6 p-4 bg-gray-100 rounded-lg">
            <p class="text-sm text-gray-500 mb-2">等价 CLI 命令:</p>
            <code id="cli-command" class="text-sm font-mono text-gray-800 break-all"></code>
        </div>
    </div>
</div>

<script>
function selectAll() {
    document.querySelectorAll('input[name="video_ids"]').forEach(cb => cb.checked = true);
}

function selectNone() {
    document.querySelectorAll('input[name="video_ids"]').forEach(cb => cb.checked = false);
}

function selectPending() {
    document.querySelectorAll('input[name="video_ids"]').forEach(cb => {
        const progressText = cb.closest('label').querySelector('.text-gray-500').textContent;
        cb.checked = !progressText.includes('100%');
    });
}

function filterVideos() {
    const query = document.getElementById('video-search').value.trim().toLowerCase();
    document.querySelectorAll('.video-item').forEach(item => {
        const title = item.dataset.title || '';
        item.style.display = title.includes(query) ? '' : 'none';
    });
}

function selectVisible() {
    document.querySelectorAll('.video-item').forEach(item => {
        if (item.style.display !== 'none') {
            item.querySelector('input[type="checkbox"]').checked = true;
        }
    });
}

function toggleSubSteps(group, checked) {
    document.querySelectorAll(`.${group}-sub`).forEach(cb => cb.checked = checked);
}

function updateGroupCheckbox(group) {
    const subs = document.querySelectorAll(`.${group}-sub`);
    const groupCb = document.getElementById(`${group}-group`);
    const checkedCount = Array.from(subs).filter(cb => cb.checked).length;
    
    if (checkedCount === 0) {
        groupCb.checked = false;
        groupCb.indeterminate = false;
    } else if (checkedCount === subs.length) {
        groupCb.checked = true;
        groupCb.indeterminate = false;
    } else {
        groupCb.checked = false;
        groupCb.indeterminate = true;
    }
}

// ========== 定时上传 UI 逻辑 ==========

function updateUploadScheduleVisibility() {
    // 定时上传区域仅在 upload 是唯一选中阶段时显示
    const steps = Array.from(document.querySelectorAll('input[name="steps"]:checked')).map(cb => cb.value);
    const section = document.getElementById('upload-schedule-section');
    if (steps.length === 1 && steps[0] === 'upload') {
        section.classList.remove('hidden');
    } else {
        section.classList.add('hidden');
        // 隐藏时取消勾选，避免意外发送 cron
        document.getElementById('enable-schedule').checked = false;
        document.getElementById('schedule-options').classList.add('hidden');
    }
}

// 监听所有 steps checkbox 的变化（包括组复选框）
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('input[name="steps"]').forEach(cb => {
        cb.addEventListener('change', updateUploadScheduleVisibility);
    });
    // 组复选框也要监听
    ['asr-group', 'translate-group'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', () => setTimeout(updateUploadScheduleVisibility, 50));
    });
});

function toggleScheduleOptions() {
    const enabled = document.getElementById('enable-schedule').checked;
    document.getElementById('schedule-options').classList.toggle('hidden', !enabled);
    if (enabled) updateScheduleMode();
}

function updateScheduleMode() {
    const mode = document.getElementById('schedule-mode').value;
    document.getElementById('mode-daily').classList.toggle('hidden', mode !== 'daily');
    document.getElementById('mode-interval').classList.toggle('hidden', mode !== 'interval');
    document.getElementById('mode-cron').classList.toggle('hidden', mode !== 'cron');
    if (mode === 'daily') updateDailyCron();
    if (mode === 'interval') updateIntervalCron();
}

function addTimeSlot() {
    const container = document.getElementById('time-slots');
    const input = document.createElement('input');
    input.type = 'time';
    input.className = 'time-slot border rounded px-2 py-1 text-sm';
    input.value = '18:00';
    input.addEventListener('change', updateDailyCron);
    container.appendChild(input);
    updateDailyCron();
}

function updateDailyCron() {
    const slots = document.querySelectorAll('.time-slot');
    const hours = new Set();
    const minutes = new Set();
    slots.forEach(s => {
        if (s.value) {
            const [h, m] = s.value.split(':').map(Number);
            hours.add(h);
            minutes.add(m);
        }
    });
    // 简化：如果所有时间点的分钟部分相同，用单一分钟值；否则用 0
    const minVal = minutes.size === 1 ? [...minutes][0] : 0;
    const hourStr = [...hours].sort((a,b) => a-b).join(',');
    const cron = `${minVal} ${hourStr || '12'} * * *`;
    document.getElementById('daily-cron-preview').textContent = cron;
}

// 绑定时间输入框 change 事件
document.addEventListener('change', e => {
    if (e.target.classList.contains('time-slot')) updateDailyCron();
});

function updateIntervalCron() {
    const h = parseInt(document.getElementById('interval-hours').value);
    let cron;
    if (h >= 24) {
        // 每 N 天
        const days = Math.floor(h / 24);
        cron = days === 1 ? '0 0 * * *' : `0 0 */${days} * *`;
    } else {
        cron = `0 */${h} * * *`;
    }
    document.getElementById('interval-cron-preview').textContent = cron;
}

function validateCronInput() {
    const input = document.getElementById('cron-input').value.trim();
    const el = document.getElementById('cron-validation');
    if (!input) {
        el.classList.add('hidden');
        return;
    }
    // 基本格式检查：5 个字段
    const parts = input.split(/\s+/);
    if (parts.length === 5) {
        el.textContent = '✓ 格式正确（服务端会进一步验证）';
        el.className = 'text-xs text-green-600';
    } else {
        el.textContent = '✗ 格式错误：需要 5 个字段（分 时 日 月 星期）';
        el.className = 'text-xs text-red-600';
    }
    el.classList.remove('hidden');
}

function getUploadCron() {
    if (!document.getElementById('enable-schedule').checked) return null;
    const mode = document.getElementById('schedule-mode').value;
    if (mode === 'daily') return document.getElementById('daily-cron-preview').textContent;
    if (mode === 'interval') return document.getElementById('interval-cron-preview').textContent;
    if (mode === 'cron') return document.getElementById('cron-input').value.trim() || null;
    return null;
}

function getFormData() {
    const form = document.getElementById('task-form');
    const videoIds = Array.from(form.querySelectorAll('input[name="video_ids"]:checked'))
        .map(cb => cb.value);
    const steps = Array.from(form.querySelectorAll('input[name="steps"]:checked'))
        .map(cb => cb.value);
    const gpuDevice = form.querySelector('select[name="gpu_device"]').value;
    const force = form.querySelector('input[name="force"]').checked;
    const concurrency = parseInt(form.querySelector('select[name="concurrency"]').value) || 1;
    const uploadCron = getUploadCron();
    
    return { videoIds, steps, gpuDevice, force, concurrency, uploadCron };
}

async function submitTask(event) {
    event.preventDefault();
    
    const { videoIds, steps, gpuDevice, force, concurrency, uploadCron } = getFormData();
    
    if (videoIds.length === 0) {
        showToast('请至少选择一个视频', 'warning');
        return;
    }
    
    if (steps.length === 0) {
        showToast('请至少选择一个阶段', 'warning');
        return;
    }
    
    // 客户端校验：定时上传要求 steps 仅为 upload
    if (uploadCron && (steps.length !== 1 || steps[0] !== 'upload')) {
        showToast('定时上传仅可用于“上传到B站”阶段', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/tasks/execute', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                video_ids: videoIds,
                steps: steps,
                gpu_device: gpuDevice,
                force: force,
                concurrency: concurrency,
                playlist_id: document.querySelector('input[name="playlist_id"]')?.value || null,
                upload_cron: uploadCron
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            location.href = `/tasks/${result.task_id}`;
        } else {
            const error = await response.json();
            showToast('提交失败: ' + (error.detail || '未知错误'), 'error');
        }
    } catch (e) {
        showToast('请求失败: ' + e.message, 'error');
    }
}

function generateCLI() {
    const { videoIds, steps, gpuDevice, force, concurrency, uploadCron } = getFormData();
    const playlistId = document.querySelector('input[name="playlist_id"]')?.value || null;
    
    let cmd = 'python -m vat process';
    videoIds.forEach(vid => cmd += ` -v ${vid}`);
    
    if (steps.length > 0 && steps.join(',') !== 'download,asr,translate,embed') {
        cmd += ` -s ${steps.join(',')}`;
    }
    
    if (gpuDevice !== 'auto') {
        cmd += ` -g ${gpuDevice}`;
    }
    
    if (force) {
        cmd += ' -f';
    }
    
    if (playlistId) {
        cmd += ` -p ${playlistId}`;
    }
    
    if (concurrency > 1) {
        cmd += ` -c ${concurrency}`;
    }
    
    if (uploadCron) {
        cmd += ` --upload-cron "${uploadCron}"`;
    }
    
    document.getElementById('cli-command').textContent = cmd;
    document.getElementById('cli-output').classList.remove('hidden');
}
</script>
{% endblock %}
