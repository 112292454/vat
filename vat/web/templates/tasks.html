{% extends "base.html" %}

{% block title %}任务 - VAT Manager{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- 页面标题 -->
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800">任务管理</h1>
        <div class="flex items-center space-x-2">
            <button id="batch-delete-btn" onclick="batchDeleteTasks()" 
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 hidden">
                删除选中 (<span id="selected-count">0</span>)
            </button>
            <button onclick="location.href='/tasks/new'" 
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                + 新建任务
            </button>
        </div>
    </div>

    <!-- 状态筛选 -->
    <div class="flex items-center space-x-2 mb-4" id="task-status-filter">
        <span class="text-gray-600 text-sm">状态:</span>
        <button onclick="filterTasks('')" class="filter-tag px-3 py-1 rounded-full text-sm bg-gray-800 text-white" data-filter-value="" data-active-class="bg-gray-800 text-white">全部</button>
        <button onclick="filterTasks('running')" class="filter-tag px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700" data-filter-value="running" data-active-class="bg-blue-600 text-white">运行中</button>
        <button onclick="filterTasks('completed')" class="filter-tag px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700" data-filter-value="completed" data-active-class="bg-green-600 text-white">已完成</button>
        <button onclick="filterTasks('partial_completed')" class="filter-tag px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700" data-filter-value="partial_completed" data-active-class="bg-orange-600 text-white">部分完成</button>
        <button onclick="filterTasks('failed')" class="filter-tag px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700" data-filter-value="failed" data-active-class="bg-red-600 text-white">失败</button>
        <button onclick="filterTasks('cancelled')" class="filter-tag px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700" data-filter-value="cancelled" data-active-class="bg-gray-600 text-white">已取消</button>
    </div>

    <!-- 任务列表 -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200" id="task-table">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-2 py-3 w-10">
                        <input type="checkbox" id="select-all" onchange="toggleSelectAll()" class="rounded">
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">任务 ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase" data-sort="2" data-sort-type="number">视频数</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">阶段</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">状态</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase" data-sort="5" data-sort-type="number">进度</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase" data-sort="6" data-sort-type="date">时间</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="task-list">
                {% for task in tasks %}
                <tr class="hover:bg-gray-50" data-filter-status="{{ task.status }}">
                    <td class="px-2 py-4">
                        <input type="checkbox" class="task-checkbox rounded" value="{{ task.task_id }}" 
                               onchange="updateSelectedCount()" {% if task.status == 'running' %}disabled{% endif %}>
                    </td>
                    <td class="px-6 py-4">
                        <a href="/tasks/{{ task.task_id }}" class="text-blue-600 hover:underline font-mono">
                            {{ task.task_id }}
                        </a>
                    </td>
                    <td class="px-6 py-4 text-sm" data-sort-value="{{ task.video_ids|length }}">{{ task.video_ids|length }}</td>
                    <td class="px-6 py-4 text-sm text-gray-600" title="{{ task.steps|join(', ') }}">
                        {{ task.steps|length }} 个阶段
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full 
                            {% if task.status == 'completed' %}bg-green-100 text-green-800
                            {% elif task.status == 'partial_completed' %}bg-orange-100 text-orange-800
                            {% elif task.status == 'running' %}bg-blue-100 text-blue-800
                            {% elif task.status == 'failed' %}bg-red-100 text-red-800
                            {% elif task.status == 'cancelled' %}bg-gray-100 text-gray-800
                            {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                            {% if task.status == 'completed' %}已完成
                            {% elif task.status == 'partial_completed' %}部分完成
                            {% elif task.status == 'running' %}运行中
                            {% elif task.status == 'failed' %}失败
                            {% elif task.status == 'cancelled' %}已取消
                            {% else %}{{ task.status }}{% endif %}
                        </span>
                    </td>
                    <td class="px-6 py-4" data-sort-value="{{ (task.progress * 100)|int }}">
                        {% set pct = (task.progress * 100)|int %}
                        {% if task.status == 'completed' %}{% set pct = 100 %}{% endif %}
                        <div class="flex items-center space-x-2">
                            <div class="w-20 bg-gray-200 rounded-full h-2">
                                <div class="h-2 rounded-full {% if task.status == 'failed' %}bg-red-500{% elif task.status == 'completed' %}bg-green-500{% else %}bg-blue-500{% endif %}" style="width: {{ pct }}%"></div>
                            </div>
                            <span class="text-xs text-gray-500 w-8">{{ pct }}%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600" data-sort-value="{{ task.created_at }}">{{ task.created_at[:16] }}</td>
                    <td class="px-6 py-4 text-sm">
                        {% if task.status == 'running' %}
                        <button onclick="cancelTask('{{ task.task_id }}')" 
                                class="text-red-600 hover:text-red-800">取消</button>
                        {% else %}
                        <a href="/tasks/{{ task.task_id }}" class="text-blue-600 hover:text-blue-800">查看</a>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                        没有任务记录
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
// 状态筛选
function filterTasks(status) {
    const table = document.getElementById('task-table');
    setActiveFilter(document.getElementById('task-status-filter'), status);
    filterTableRows(table, row => !status || row.dataset.filterStatus === status);
}

// 初始化表格排序
document.addEventListener('DOMContentLoaded', () => {
    initSortableTable(document.getElementById('task-table'));
});

// 选择相关
function toggleSelectAll() {
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.task-checkbox:not(:disabled)');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
    updateSelectedCount();
}

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.task-checkbox:checked');
    const count = checkboxes.length;
    document.getElementById('selected-count').textContent = count;
    document.getElementById('batch-delete-btn').classList.toggle('hidden', count === 0);
}

// 批量删除
async function batchDeleteTasks() {
    const checkboxes = document.querySelectorAll('.task-checkbox:checked');
    const ids = Array.from(checkboxes).map(cb => cb.value);
    
    if (ids.length === 0) return;
    if (!confirm(`确定要删除选中的 ${ids.length} 个任务？\n\n此操作不可恢复！`)) return;
    
    let success = 0, failed = 0;
    for (const id of ids) {
        try {
            const response = await fetch(`/api/tasks/${id}`, {method: 'DELETE'});
            if (response.ok) success++;
            else failed++;
        } catch (e) {
            failed++;
        }
    }
    
    showToast(`删除完成：成功 ${success} 个，失败 ${failed} 个`, success > 0 ? 'success' : 'warning');
    setTimeout(() => location.reload(), 1000);
}

async function cancelTask(taskId) {
    if (!confirm('确定要取消此任务?')) return;
    
    try {
        const response = await fetch(`/api/tasks/${taskId}/cancel`, {method: 'POST'});
        if (response.ok) {
            location.reload();
        } else {
            const error = await response.json();
            showToast('取消失败: ' + (error.detail || '未知错误'), 'error');
        }
    } catch (e) {
        showToast('请求失败: ' + e.message, 'error');
    }
}

// 自动刷新运行中的任务
setInterval(() => {
    const hasRunning = document.querySelector('[class*="bg-blue-100"]');
    if (hasRunning) {
        location.reload();
    }
}, 5000);
</script>
{% endblock %}
