{% extends "base.html" %}

{% block title %}{{ video.title or 'è§†é¢‘è¯¦æƒ…' }} - VAT Manager{% endblock %}

{% block content %}
<!-- è¿”å›æŒ‰é’®ï¼šæ ¹æ®æ¥æºå†³å®šè¿”å›ç›®æ ‡ -->
{% if from_playlist and playlist_id %}
<a href="/playlists/{{ playlist_id }}" class="inline-flex items-center text-gray-600 hover:text-gray-800 mb-4">
    â† è¿”å› Playlist
</a>
{% else %}
<a href="/" class="inline-flex items-center text-gray-600 hover:text-gray-800 mb-4">
    â† è¿”å›è§†é¢‘åˆ—è¡¨
</a>
{% endif %}

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- å·¦ä¾§ï¼šè§†é¢‘ä¿¡æ¯ -->
    <div class="lg:col-span-2 space-y-6">
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-start space-x-4">
                {% if metadata and metadata.thumbnail %}
                <img src="{{ metadata.thumbnail }}" alt="" class="w-48 h-28 object-cover rounded-lg">
                {% else %}
                <div class="w-48 h-28 bg-gray-200 rounded-lg flex items-center justify-center text-4xl text-gray-400">
                    ğŸ¬
                </div>
                {% endif %}
                <div class="flex-1 min-w-0">
                    <h1 class="text-xl font-bold text-gray-900 mb-2">{{ video.title or 'æœªçŸ¥æ ‡é¢˜' }}</h1>
                    {% if translated_info and translated_info.title_optimized %}
                    <div class="text-blue-600 mb-2">
                        <span class="text-gray-500 text-sm">ç¿»è¯‘æ ‡é¢˜:</span>
                        {{ translated_info.title_optimized }}
                    </div>
                    {% endif %}
                    <div class="flex flex-wrap gap-2 text-sm text-gray-600">
                        <span class="inline-flex items-center px-2 py-0.5 rounded bg-gray-100">
                            {{ video.source_type.value }}
                        </span>
                        {% if metadata and metadata.duration %}
                        <span>æ—¶é•¿: {{ metadata.duration | format_duration }}</span>
                        {% endif %}
                        {% if metadata and metadata.channel %}
                        <span>é¢‘é“: {{ metadata.channel }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- æºé“¾æ¥ -->
            <div class="mt-4 pt-4 border-t">
                <div class="text-sm text-gray-500 mb-1">æºåœ°å€</div>
                <a href="{{ video.source_url }}" target="_blank" class="text-blue-600 hover:underline break-all">
                    {{ video.source_url }}
                </a>
            </div>
        </div>
        
        <!-- å¤„ç†è­¦å‘Šï¼ˆéè‡´å‘½é—®é¢˜ï¼‰ -->
        {% if video.processing_notes %}
        <div class="bg-amber-50 border border-amber-200 rounded-lg shadow p-4">
            <div class="flex items-start space-x-2">
                <span class="text-amber-500 text-lg flex-shrink-0">âš </span>
                <div class="flex-1 min-w-0">
                    <h3 class="text-sm font-semibold text-amber-800 mb-1">å¤„ç†è¿‡ç¨‹ä¸­å­˜åœ¨éè‡´å‘½é—®é¢˜</h3>
                    <ul class="text-sm text-amber-700 space-y-1">
                        {% for note in video.processing_notes %}
                        <li>
                            <span class="font-medium">[{{ note.stage }}]</span>
                            {{ note.message }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- ä»»åŠ¡æ—¶é—´çº¿ -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold">å¤„ç†è¿›åº¦</h2>
                {% if active_job_id %}
                <a href="/tasks/{{ active_job_id }}" 
                   class="inline-flex items-center px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200 animate-pulse">
                    âŸ³ æ­£åœ¨å¤„ç†ä¸­ â€” æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…
                </a>
                {% endif %}
            </div>
            <div class="space-y-3">
                {% for task in task_timeline %}
                <div class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-gray-50 group
                            {% if task.status == 'completed' %}border-green-200 bg-green-50{% endif %}
                            {% if task.status == 'running' %}border-blue-200 bg-blue-50{% endif %}
                            {% if task.status == 'failed' %}border-red-200 bg-red-50{% endif %}">
                    <!-- çŠ¶æ€å›¾æ ‡ -->
                    <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center
                                {% if task.status == 'completed' %}bg-green-500 text-white
                                {% elif task.status == 'running' %}bg-blue-500 text-white animate-pulse
                                {% elif task.status == 'failed' %}bg-red-500 text-white
                                {% else %}bg-gray-200 text-gray-600{% endif %}">
                        {% if task.status == 'completed' %}âœ“
                        {% elif task.status == 'running' %}âŸ³
                        {% elif task.status == 'failed' %}âœ—
                        {% else %}{{ loop.index }}{% endif %}
                    </div>
                    
                    <!-- é˜¶æ®µä¿¡æ¯ -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <span class="font-medium text-gray-900">{{ task.step_name }}</span>
                            <span class="text-xs text-gray-500">
                                {% if task.status == 'completed' %}å·²å®Œæˆ
                                {% elif task.status == 'running' %}è¿è¡Œä¸­
                                {% elif task.status == 'failed' %}å¤±è´¥
                                {% else %}å¾…å¤„ç†{% endif %}
                            </span>
                        </div>
                        {% if task.completed_at %}
                        <div class="text-xs text-gray-500">{{ task.completed_at[:16].replace('T', ' ') }}</div>
                        {% endif %}
                        {% if task.error_message %}
                        <div class="mt-1 text-xs text-red-600 bg-red-100 rounded p-1">
                            {{ task.error_message[:100] }}{% if task.error_message|length > 100 %}...{% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="opacity-0 group-hover:opacity-100 flex space-x-1">
                        {% if task.status != 'running' %}
                        <button onclick="runStep('{{ task.step }}', false)" 
                                class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200"
                                title="æ‰§è¡Œæ­¤é˜¶æ®µ">
                            â–¶
                        </button>
                        {% if task.status == 'completed' %}
                        <button onclick="runStep('{{ task.step }}', true)" 
                                class="px-2 py-1 text-xs bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200"
                                title="å¼ºåˆ¶é‡æ–°æ‰§è¡Œ">
                            â†º
                        </button>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- å¿«æ·æ“ä½œ -->
            <div class="mt-4 pt-4 border-t flex flex-wrap gap-2">
                <button onclick="runNextStep()" 
                        class="px-3 py-1.5 text-sm bg-green-600 text-white rounded hover:bg-green-700">
                    æ‰§è¡Œä¸‹ä¸€æ­¥
                </button>
                <button onclick="showStepSelector()" 
                        class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
                    é€‰æ‹©é˜¶æ®µæ‰§è¡Œ...
                </button>
                <button onclick="generateCLI()" 
                        class="px-3 py-1.5 text-sm border text-gray-600 rounded hover:bg-gray-100">
                    ç”Ÿæˆ CLI å‘½ä»¤
                </button>
                <button onclick="deleteVideo()" 
                        class="px-3 py-1.5 text-sm bg-red-600 text-white rounded hover:bg-red-700">
                    åˆ é™¤è§†é¢‘
                </button>
            </div>
            
            <!-- CLI å‘½ä»¤æ˜¾ç¤º -->
            <div id="cli-output" class="hidden mt-3 p-3 bg-gray-100 rounded text-xs font-mono break-all"></div>
        </div>
        
        <!-- ç¿»è¯‘ä¿¡æ¯ -->
        {% if translated_info %}
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold mb-4">ç¿»è¯‘ä¿¡æ¯</h2>
            
            {% if translated_info.title_translated %}
            <div class="mb-4">
                <div class="text-sm text-gray-500 mb-1">ç¿»è¯‘æ ‡é¢˜</div>
                <div class="text-blue-600 font-medium">{{ translated_info.title_translated }}</div>
            </div>
            {% endif %}
            
            {% set desc_summary = translated_info.description_summary or translated_info.get('description_optimized', '') %}
            {% if desc_summary %}
            <div class="mb-4">
                <div class="text-sm text-gray-500 mb-1">ç®€ä»‹æ‘˜è¦</div>
                <div class="text-gray-900 whitespace-pre-wrap">{{ desc_summary }}</div>
            </div>
            {% endif %}
            
            {% if translated_info.description_translated %}
            <div class="mb-4">
                <div class="text-sm text-gray-500 mb-1">å®Œæ•´ç¿»è¯‘ç®€ä»‹</div>
                <div class="text-gray-700 whitespace-pre-wrap text-sm max-h-48 overflow-y-auto">{{ translated_info.description_translated }}</div>
            </div>
            {% endif %}
            
            {% if translated_info.tags_generated %}
            <div class="mb-4">
                <div class="text-sm text-gray-500 mb-1">ç”Ÿæˆæ ‡ç­¾</div>
                <div class="flex flex-wrap gap-2">
                    {% for tag in translated_info.tags_generated %}
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-sm rounded">{{ tag }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            {% if translated_info.recommended_tid_name %}
            <div>
                <div class="text-sm text-gray-500 mb-1">æ¨èåˆ†åŒº</div>
                <span class="px-2 py-1 bg-green-100 text-green-800 text-sm rounded">
                    {{ translated_info.recommended_tid_name }}
                </span>
                {% if translated_info.tid_reason %}
                <span class="text-sm text-gray-500 ml-2">{{ translated_info.tid_reason }}</span>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% endif %}
        
        <!-- ç›¸å…³æ–‡ä»¶ -->
        {% if files %}
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold mb-4">ç›¸å…³æ–‡ä»¶</h2>
            <div class="space-y-2">
                {% for file in files %}
                <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded group">
                    <div class="flex items-center space-x-2">
                        <span class="text-lg">
                            {% if file.ext in ['.mp4', '.webm', '.mkv'] %}ğŸ¬
                            {% elif file.ext in ['.srt', '.ass', '.vtt'] %}ğŸ“„
                            {% elif file.ext in ['.json'] %}ğŸ“‹
                            {% elif file.ext in ['.mp3', '.wav', '.m4a'] %}ğŸµ
                            {% else %}ğŸ“{% endif %}
                        </span>
                        <span class="text-sm text-gray-900">{{ file.name }}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-500">{{ (file.size / 1024 / 1024) | round(1) }} MB</span>
                        {% if file.ext in ['.srt', '.ass', '.json', '.txt', '.log'] %}
                        <button onclick="viewFile('{{ file.name }}')" 
                                class="opacity-0 group-hover:opacity-100 px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                            æŸ¥çœ‹
                        </button>
                        {% endif %}
                        {% if file.ext in ['.srt', '.ass', '.json', '.txt'] %}
                        <button onclick="editFile('{{ file.name }}')" 
                                class="opacity-0 group-hover:opacity-100 px-2 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200">
                            ç¼–è¾‘
                        </button>
                        {% endif %}
                        {% if file.ext in ['.mp4', '.webm', '.mkv'] %}
                        <button onclick="previewVideo('{{ file.name }}')" 
                                class="opacity-0 group-hover:opacity-100 px-2 py-1 text-xs bg-purple-100 text-purple-700 rounded hover:bg-purple-200">
                            æ’­æ”¾
                        </button>
                        {% endif %}
                        {% if file.ext in ['.mp3', '.wav', '.m4a'] %}
                        <button onclick="previewAudio('{{ file.name }}')" 
                                class="opacity-0 group-hover:opacity-100 px-2 py-1 text-xs bg-orange-100 text-orange-700 rounded hover:bg-orange-200">
                            æ’­æ”¾
                        </button>
                        {% endif %}
                        <a href="/api/files/download/{{ video.id }}/{{ file.name }}" 
                           class="opacity-0 group-hover:opacity-100 px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                            ä¸‹è½½
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- æ–‡ä»¶æŸ¥çœ‹/ç¼–è¾‘æ¨¡æ€æ¡† -->
        <div id="file-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col m-4">
                <div class="flex justify-between items-center px-6 py-4 border-b">
                    <h3 id="modal-title" class="text-lg font-semibold">æ–‡ä»¶å†…å®¹</h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <div class="flex-1 overflow-auto p-6">
                    <pre id="file-content" class="text-sm font-mono whitespace-pre-wrap bg-gray-50 p-4 rounded"></pre>
                    <textarea id="file-editor" class="hidden w-full h-96 font-mono text-sm p-4 border rounded"></textarea>
                </div>
                <div id="modal-actions" class="px-6 py-4 border-t flex justify-end space-x-2">
                    <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">å…³é—­</button>
                    <button id="save-btn" onclick="saveFile()" class="hidden px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ä¿å­˜</button>
                </div>
            </div>
        </div>
        
        <!-- åª’ä½“é¢„è§ˆæ¨¡æ€æ¡† -->
        <div id="media-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-5xl max-h-[90vh] flex flex-col m-4">
                <div class="flex justify-between items-center px-6 py-4 border-b">
                    <h3 id="media-title" class="text-lg font-semibold">åª’ä½“é¢„è§ˆ</h3>
                    <button onclick="closeMediaModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <div class="flex-1 overflow-auto p-6 flex items-center justify-center bg-black">
                    <video id="video-player" class="hidden max-w-full max-h-[70vh]" controls></video>
                    <audio id="audio-player" class="hidden w-full" controls></audio>
                </div>
            </div>
        </div>
        
        <script>
        const videoId = '{{ video.id }}';
        let currentFilename = '';
        let isEditMode = false;
        
        async function viewFile(filename) {
            currentFilename = filename;
            isEditMode = false;
            
            try {
                const response = await fetch(`/api/files/view/${videoId}/${filename}`);
                if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');
                
                const data = await response.json();
                
                document.getElementById('modal-title').textContent = filename;
                document.getElementById('file-content').textContent = data.content;
                document.getElementById('file-content').classList.remove('hidden');
                document.getElementById('file-editor').classList.add('hidden');
                document.getElementById('save-btn').classList.add('hidden');
                document.getElementById('file-modal').classList.remove('hidden');
            } catch (e) {
                showToast('åŠ è½½æ–‡ä»¶å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        async function editFile(filename) {
            currentFilename = filename;
            isEditMode = true;
            
            try {
                const response = await fetch(`/api/files/view/${videoId}/${filename}`);
                if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');
                
                const data = await response.json();
                
                document.getElementById('modal-title').textContent = 'ç¼–è¾‘: ' + filename;
                document.getElementById('file-content').classList.add('hidden');
                document.getElementById('file-editor').value = data.content;
                document.getElementById('file-editor').classList.remove('hidden');
                document.getElementById('save-btn').classList.remove('hidden');
                document.getElementById('file-modal').classList.remove('hidden');
            } catch (e) {
                showToast('åŠ è½½æ–‡ä»¶å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        async function saveFile() {
            const content = document.getElementById('file-editor').value;
            
            try {
                const response = await fetch(`/api/files/save/${videoId}/${currentFilename}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({content: content})
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'ä¿å­˜å¤±è´¥');
                }
                
                const result = await response.json();
                showToast(`ä¿å­˜æˆåŠŸï¼å·²å¤‡ä»½ä¸º ${result.backup}`, 'success');
                closeModal();
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        function closeModal() {
            document.getElementById('file-modal').classList.add('hidden');
        }
        
        // ESC å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeMediaModal();
            }
        });
        
        // è§†é¢‘é¢„è§ˆ
        function previewVideo(filename) {
            document.getElementById('media-title').textContent = 'è§†é¢‘é¢„è§ˆ: ' + filename;
            const video = document.getElementById('video-player');
            const audio = document.getElementById('audio-player');
            
            video.src = `/api/files/view/${videoId}/${filename}`;
            video.classList.remove('hidden');
            audio.classList.add('hidden');
            audio.pause();
            
            document.getElementById('media-modal').classList.remove('hidden');
        }
        
        // éŸ³é¢‘é¢„è§ˆ
        function previewAudio(filename) {
            document.getElementById('media-title').textContent = 'éŸ³é¢‘é¢„è§ˆ: ' + filename;
            const video = document.getElementById('video-player');
            const audio = document.getElementById('audio-player');
            
            audio.src = `/api/files/view/${videoId}/${filename}`;
            audio.classList.remove('hidden');
            video.classList.add('hidden');
            video.pause();
            
            document.getElementById('media-modal').classList.remove('hidden');
        }
        
        // å…³é—­åª’ä½“æ¨¡æ€æ¡†
        function closeMediaModal() {
            document.getElementById('media-modal').classList.add('hidden');
            document.getElementById('video-player').pause();
            document.getElementById('audio-player').pause();
        }
        </script>
    </div>
    
    <!-- å³ä¾§ï¼šå…ƒæ•°æ® -->
    <div class="space-y-6">
        <!-- ID å’Œæ—¶é—´ -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-sm font-semibold text-gray-500 uppercase mb-3">ç³»ç»Ÿä¿¡æ¯</h3>
            <div class="space-y-2 text-sm">
                <div>
                    <span class="text-gray-500">è§†é¢‘ ID:</span>
                    <span class="font-mono text-gray-900">{{ video.id }}</span>
                </div>
                <div>
                    <span class="text-gray-500">åˆ›å»ºæ—¶é—´:</span>
                    <span class="text-gray-900">{{ video.created_at | format_datetime }}</span>
                </div>
                <div>
                    <span class="text-gray-500">æ›´æ–°æ—¶é—´:</span>
                    <span class="text-gray-900">{{ video.updated_at | format_datetime }}</span>
                </div>
                {% if video.output_dir %}
                <div>
                    <span class="text-gray-500">è¾“å‡ºç›®å½•:</span>
                    <span class="font-mono text-xs text-gray-900 break-all">{{ video.output_dir }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- åŸå§‹å…ƒæ•°æ® -->
        {% if metadata %}
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-sm font-semibold text-gray-500 uppercase mb-3">åŸå§‹å…ƒæ•°æ®</h3>
            <div class="space-y-2 text-sm">
                {% if metadata.channel %}
                <div><span class="text-gray-500">é¢‘é“:</span> {{ metadata.channel }}</div>
                {% endif %}
                {% if metadata.upload_date %}
                <div><span class="text-gray-500">ä¸Šä¼ æ—¥æœŸ:</span> {{ metadata.upload_date }}</div>
                {% endif %}
                {% if metadata.duration %}
                <div><span class="text-gray-500">æ—¶é•¿:</span> {{ metadata.duration | format_duration }}</div>
                {% endif %}
                {% if metadata.view_count %}
                <div><span class="text-gray-500">æ’­æ”¾é‡:</span> {{ metadata.view_count }}</div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-sm font-semibold text-gray-500 uppercase mb-3">æ“ä½œ</h3>
            <div class="space-y-2">
                <a href="/tasks/new?video={{ video.id }}{% if playlist_id %}&playlist={{ playlist_id }}{% endif %}" 
                   class="block w-full px-4 py-2 bg-blue-600 text-white text-center rounded hover:bg-blue-700">
                    å¤„ç†æ­¤è§†é¢‘
                </a>
                <button onclick="reprocessVideo('{{ video.id }}')" 
                        class="w-full px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">
                    å¼ºåˆ¶é‡æ–°å¤„ç†
                </button>
            </div>
        </div>
        
        <script>
        const taskTimeline = {{ task_timeline | tojson }};
        
        async function reprocessVideo(videoId) {
            if (!confirm('ç¡®å®šè¦å¼ºåˆ¶é‡æ–°å¤„ç†æ­¤è§†é¢‘ï¼Ÿè¿™å°†é‡æ–°æ‰§è¡Œæ‰€æœ‰é˜¶æ®µã€‚')) return;
            
            try {
                const response = await fetch('/api/tasks/execute', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        video_ids: [videoId],
                        steps: ['download', 'whisper', 'split', 'optimize', 'translate', 'embed', 'upload'],
                        gpu_device: 'auto',
                        force: true
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    location.href = `/tasks/${result.task_id}`;
                } else {
                    const error = await response.json();
                    showToast('æäº¤å¤±è´¥: ' + (error.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (e) {
                showToast('è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        async function runStep(step, force) {
            const action = force ? 'å¼ºåˆ¶é‡æ–°æ‰§è¡Œ' : 'æ‰§è¡Œ';
            if (!confirm(`ç¡®å®šè¦${action}é˜¶æ®µ: ${step}ï¼Ÿ`)) return;
            
            try {
                const response = await fetch('/api/tasks/execute', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        video_ids: [videoId],
                        steps: [step],
                        gpu_device: 'auto',
                        force: force
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    location.href = `/tasks/${result.task_id}`;
                } else {
                    const error = await response.json();
                    showToast('æäº¤å¤±è´¥: ' + (error.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (e) {
                showToast('è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        function runNextStep() {
            const pendingSteps = taskTimeline.filter(t => t.status === 'pending' || t.status === 'failed');
            if (pendingSteps.length === 0) {
                showToast('æ‰€æœ‰é˜¶æ®µå·²å®Œæˆï¼', 'success');
                return;
            }
            runStep(pendingSteps[0].step, false);
        }
        
        function showStepSelector() {
            let url = `/tasks/new?video=${videoId}`;
            {% if playlist_id %}url += '&playlist={{ playlist_id }}';{% endif %}
            location.href = url;
        }
        
        function generateCLI() {
            const pendingSteps = taskTimeline.filter(t => t.status !== 'completed').map(t => t.step);
            let cmd = `vat process -v ${videoId}`;
            if (pendingSteps.length > 0) {
                cmd += ` -s ${pendingSteps.join(',')}`;
            }
            document.getElementById('cli-output').textContent = cmd;
            document.getElementById('cli-output').classList.remove('hidden');
        }
        
        function deleteVideo() {
            document.getElementById('delete-video-modal').classList.remove('hidden');
            document.getElementById('delete-video-modal').classList.add('flex');
        }
        
        function closeDeleteModal() {
            document.getElementById('delete-video-modal').classList.add('hidden');
            document.getElementById('delete-video-modal').classList.remove('flex');
        }
        
        async function confirmDeleteVideo() {
            const deleteAllFiles = document.getElementById('delete-all-files').checked;
            
            try {
                const response = await fetch(`/api/videos/${videoId}?delete_all_files=${deleteAllFiles}`, {method: 'DELETE'});
                if (response.ok) {
                    showToast('åˆ é™¤æˆåŠŸ', 'success');
                    setTimeout(() => location.href = '/', 1000);
                } else {
                    const error = await response.json();
                    showToast('åˆ é™¤å¤±è´¥: ' + (error.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (e) {
                showToast('è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
            }
            closeDeleteModal();
        }
        
        // ESC å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDeleteModal();
                closeModal();
                closeMediaModal();
            }
        });
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.addEventListener('DOMContentLoaded', function() {
            setupModalClickOutside('delete-video-modal', closeDeleteModal);
            setupModalClickOutside('file-modal', closeModal);
            setupModalClickOutside('media-modal', closeMediaModal);
        });
        </script>
    </div>
</div>

<!-- åˆ é™¤è§†é¢‘ç¡®è®¤å¼¹çª— -->
<div id="delete-video-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
        <h3 class="text-lg font-bold mb-4 text-red-600">åˆ é™¤è§†é¢‘</h3>
        <p class="text-gray-600 mb-4">ç¡®å®šè¦åˆ é™¤æ­¤è§†é¢‘å—ï¼Ÿæ­¤æ“ä½œå°†åˆ é™¤æ•°æ®åº“è®°å½•å’Œç›¸å…³ä»»åŠ¡ã€‚</p>
        
        <div class="bg-gray-50 rounded p-3 mb-4">
            <label class="flex items-start space-x-2 cursor-pointer">
                <input type="checkbox" id="delete-all-files" class="mt-1 rounded">
                <div>
                    <span class="text-sm font-medium text-gray-700">åŒæ—¶åˆ é™¤æ‰€æœ‰æ–‡ä»¶</span>
                    <p class="text-xs text-gray-500">å‹¾é€‰åå°†åˆ é™¤æ•´ä¸ªè¾“å‡ºç›®å½•ï¼ŒåŒ…æ‹¬åŸå§‹ä¸‹è½½çš„è§†é¢‘ã€éŸ³é¢‘å’Œå­—å¹•æ–‡ä»¶</p>
                </div>
            </label>
        </div>
        
        <p class="text-xs text-gray-500 mb-4">
            é»˜è®¤åªåˆ é™¤å¤„ç†äº§ç‰©ï¼ˆç¿»è¯‘å­—å¹•ã€åµŒå…¥è§†é¢‘ç­‰ï¼‰ï¼Œä¿ç•™åŸå§‹ä¸‹è½½æ–‡ä»¶ã€‚
        </p>
        
        <div class="flex justify-end space-x-2">
            <button onclick="closeDeleteModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
            <button onclick="confirmDeleteVideo()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">ç¡®è®¤åˆ é™¤</button>
        </div>
    </div>
</div>
{% endblock %}
